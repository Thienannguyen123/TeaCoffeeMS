<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>teacoffeMS - Hệ thống quản lý cà phê</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Giao diện đăng nhập*/
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 50%, #F4A460 100%);
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            background: linear-gradient(135deg, #8B4513, #D2691E);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .logo::after {
            content: " ✨";
            -webkit-text-fill-color: #D2691E;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-group input:focus {
            outline: none;
            border-color: #D2691E;
            background: white;
            box-shadow: 0 0 0 3px rgba(210, 105, 30, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #8B4513, #D2691E);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        /*  Giao diện dashboard */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            background: linear-gradient(135deg, #8B4513, #D2691E);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.8rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            color: white;
        }

        .admin .user-badge {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .staff .user-badge {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .logout-btn {
            padding: 8px 16px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .admin .card {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1));
            border-left: 4px solid #f59e0b;
        }

        .staff .card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(29, 78, 216, 0.1));
            border-left: 4px solid #3b82f6;
        }

        .card h3 {
            margin-bottom: 15px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: 1.5rem;
        }

        /* Thống kê */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .admin .stat-card {
            background: linear-gradient(135deg, #fef3c7, #fbbf24);
        }

        .staff .stat-card {
            background: linear-gradient(135deg, #dbeafe, #60a5fa);
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
        }

        /*  tab điều hướng  */
        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .nav-tab {
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-weight: 500;
            color: #6b7280;
        }

        .nav-tab.active {
            color: white;
            font-weight: 600;
        }

        .admin .nav-tab.active {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .staff .nav-tab.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(0, 0, 0, 0.05);
        }

        /* Khu vực nội dung */
        .content-area {
            display: none;
        }

        .content-area.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /*  Bảng  */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        tr:hover {
            background: #f9fafb;
        }

        /* Nút */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 2px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Giao diện nhập dữ liệu từ người dùng */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-control {
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Mô hình dữ liệu và cách xử lý */
        /* Modal mờ nền */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    backdrop-filter: blur(5px);
}

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
    background: white;
    border-radius: 15px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    animation: modalSlideIn 0.3s ease-out;
}


        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e5e7eb;
}
    .modal * {
    box-sizing: border-box;
}

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: #ef4444;
        }

        /* Vai trò nhân viên */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-inactive {
            background: #f3f4f6;
            color: #374151;
        }

        /* Vai trò admin*/
        .role-admin {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .role-staff {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .role-cashier {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .role-barista {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

       /* Tương thích đa thiết bị */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

       /* Ẩn thanh cuộn nhưng vẫn giữ chức năng cuộn */
        .nav-tabs {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer 10+ */
        }

        .nav-tabs::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }

        /* Thông báo dạng toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            animation: toastSlideIn 0.3s ease-out;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast.error {
            background: #ef4444;
        }

        .toast.warning {
            background: #f59e0b;
        }

.badge-shift {
    background: #e0f2fe;
    color: #0369a1;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
}

.btn-sm {
    padding: 2px 8px;
    font-size: 12px;
}


    </style>
</head>
<body>
    <div id="loginSection" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1 class="logo">teacoffeMS</h1>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Tên đăng nhập:</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Mật khẩu:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="login-btn">Đăng nhập</button>
                <div id="g_id_signin"></div>
            </form>
        </div>
    </div>

    <div id="adminDashboard" class="dashboard admin">
        <div class="container">
            <div class="header">
                <h1> Dashboard Quản lý</h1>
                <div class="user-info">
                    <span class="user-badge"> Quản lý</span>
                    <button class="logout-btn" onclick="logout()">Đăng xuất</button>
                </div>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showAdminContent('products', this)"> Sản phẩm</button>
                <button class="nav-tab" onclick="showAdminContent('staff', this)"> Nhân viên</button>
                <button class="nav-tab" onclick="showAdminContent('orders', this)"> Đơn hàng</button>
                <button class="nav-tab" onclick="showAdminContent('revenue', this)">Doanh thu</button>
                <button class="nav-tab" onclick="showAdminContent('attendance', this)"> Điểm danh</button>
                <button class="nav-tab" onclick="showAdminContent('leaves', this)"> Nghỉ phép</button>
                <button class="nav-tab" onclick="showAdminContent('tables', this)"> Quản lý bàn</button>
            </div>

            <div id="admin-products" class="content-area active">
                <div class="card">
                    <h3>Quản lý sản phẩm</h3>
                    <button class="btn btn-primary" onclick="showAddProductModal()">+ Thêm sản phẩm</button>
                    <div class="table-container" style="margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tên sản phẩm</th>
                                    <th>Loại</th>
                                    <th>Giá</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="admin-staff" class="content-area">
                <div class="card">
                    <h3> Quản lý nhân viên</h3>
                    <button class="btn btn-primary" onclick="showAddStaffModal()">+ Thêm nhân viên</button>
                    <div class="table-container" style="margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Họ tên</th>
                                    <th>Chức vụ</th>
                                    <th>Email</th>
                                    <th>Số điện thoại</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="staffTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="admin-orders" class="content-area">
    <div class="card">
        <h3>Quản lý đơn hàng</h3>

        <div class="search-box" style="display: flex; gap: 10px; margin-top: 20px; align-items: center;">
            <input type="text" id="orderSearchInput" class="form-control" placeholder="Nhập mã đơn hàng..." style="width: 200px;">
            <button class="btn btn-primary" onclick="searchOrder()">Tìm kiếm</button>
            <button class="btn btn-secondary" onclick="resetOrderSearch()" style="background: #6c757d; color: white;">Làm mới</button>
        </div>
        <div class="table-container" style="margin-top: 20px;">
            <table>
                <thead>
                    <tr>
                        <th>Mã đơn</th>
                        <th>Bàn số</th>
                        <th>Tổng tiền</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

            <div id="admin-revenue" class="content-area">
    <div class="card">
        <h3>Báo cáo doanh thu chi tiết</h3>

        <div class="filter-controls" style="display: flex; gap: 10px; align-items: center; margin: 15px 0; flex-wrap: wrap;">
            <label>Từ:</label>
            <input type="date" id="revFrom" class="form-control" style="padding: 5px;">

            <label>Đến:</label>
            <input type="date" id="revTo" class="form-control" style="padding: 5px;">

            <button class="btn" style="background: #e0e0e0; color: #333;" onclick="filterRevenue('today')">Hôm nay</button>
            <button class="btn" style="background: #e0e0e0; color: #333;" onclick="filterRevenue('week')">Tuần này</button>
            <button class="btn" style="background: #e0e0e0; color: #333;" onclick="filterRevenue('month')">Tháng này</button>
            
            
        </div>

        <div style="margin-bottom: 10px; font-weight: bold; font-size: 1.1em;">
            Tổng doanh thu: <span id="totalRevenueSum" style="color: red;">0 VNĐ</span>
        </div>

        <div class="table-container">
            <table width="100%">
                <thead>
                    <tr>
                        <th>Ngày</th>
                        <th>Doanh thu (VNĐ)</th>
                    </tr>
                </thead>
                <tbody id="revenueTableBody"></tbody>
            </table>
        </div>

        <hr style="margin: 30px 0; border: 0; border-top: 1px solid #ddd;">

        <h3>Top sản phẩm bán chạy</h3>
        <div class="table-container">
            <table width="100%">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th>Tên món</th>
                        <th>Loại</th>
                        <th>Số lượng bán</th>
                        <th>Đơn giá hiện tại</th>
                    </tr>
                </thead>
                <tbody id="topProductsBody">
                    </tbody>
            </table>
        </div>

    </div>
</div>
            <div id="admin-attendance" class="content-area">
    
    <div class="card">
        <h3>Theo dõi chấm công & Vi phạm</h3>
        
        <div class="filter-controls" style="display: flex; gap: 10px; align-items: center; margin: 20px 0; background: #f9f9f9; padding: 15px; border-radius: 8px;">
            <div style="flex: 1;">
                <label style="font-weight: bold; font-size: 12px;">Chọn nhân viên:</label>
                <select id="filterEmployee" class="form-control" onchange="loadAttendanceReport()">
                    <option value="all">-- Tất cả nhân viên --</option>
                </select>
            </div>
            
            <div style="flex: 1;">
                <label style="font-weight: bold; font-size: 12px;">Từ ngày:</label>
                <input type="date" id="filterFromDate" class="form-control" onchange="loadAttendanceReport()">
            </div>

            <div style="flex: 1;">
                <label style="font-weight: bold; font-size: 12px;">Đến ngày:</label>
                <input type="date" id="filterToDate" class="form-control" onchange="loadAttendanceReport()">
            </div>
            
            <div style="align-self: flex-end;">
                 <button class="btn btn-primary" onclick="loadAttendanceReport()"><i class="fas fa-search"></i> Xem báo cáo</button>
            </div>
        </div>

        <div class="table-container">
            <table width="100%">
                <thead>
                    <tr>
                        <th>Ngày</th>
                        <th>Nhân viên</th>
                        <th>Ca làm</th>
                        <th>Giờ vào (Thực tế)</th>
                        <th>Giờ ra (Thực tế)</th>
                        <th>Đánh giá / Vi phạm</th>
                    </tr>
                </thead>
                <tbody id="attendanceReportBody">
                    </tbody>
            </table>
        </div>

    </div>
</div>

            <div id="admin-leaves" class="content-area">
                <div class="card">
                    <h3> Quản lý nghỉ phép</h3>
                    <div class="table-container" style="margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nhân viên</th>
                                    <th>Loại phép</th>
                                    <th>Từ ngày</th>
                                    <th>Đến ngày</th>
                                    <th>Số ngày</th>
                                    <th>Lý do</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="leavesTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="admin-tables" class="content-area">
                <div class="card">
                    <h3>Quản lý bàn</h3>
                    <button class="btn btn-primary" onclick="showAddTableModal()">+ Thêm bàn</button>
                    <div id="adminTableGrid" style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="staffDashboard" class="dashboard staff">
        <div class="container">
            <div class="header">
                <h1> Dashboard Nhân viên</h1>
                <div class="user-info">
                    <span class="user-badge"> Nhân viên</span>
                    <button class="logout-btn" onclick="logout()">Đăng xuất</button>
                </div>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showStaffContent('orders', this)">Tạo order</button>
                <button class="nav-tab" onclick="showStaffContent('payment', this)"> Thanh toán</button>
                <button class="nav-tab" onclick="showStaffContent('menu', this)"> Thực đơn</button>
                <button class="nav-tab" onclick="showStaffContent('shifts', this)"> Ca làm việc</button>
                <button class="nav-tab" onclick="showStaffContent('leaves', this)"> Nghỉ phép</button>
                <button class="nav-tab" onclick="showChangePasswordModal()">Đổi mật khẩu</button>
                <button id="navAttendanceBtn" class="nav-tab" 
            onclick="handleNavAttendanceClick()" 
            style="margin-left: auto; background-color: #2ecc71; color: white; font-weight: bold; border: none;">
        <i class="fas fa-clock"></i> Đang tải...
    </button>
            </div>

            <div id="staff-orders" class="content-area active">
                <div class="card">
                    <h3>Tạo đơn hàng</h3>
                    <div class="form-row">
                        <select class="form-control" id="orderTable">
                            <option value="">Chọn bàn</option>
                            </select>
                    </div>
                    
                    <h4 style="margin: 20px 0 10px 0;">Chọn món:</h4>
                    
                    <div id="staffMenuGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        </div>

                    <div id="orderSummary" style="margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
                        <h4>Đơn hàng hiện tại:</h4>
                        <div id="orderItems"></div>
                        <p><strong>Tổng tiền: <span id="orderTotal">0 VNĐ</span></strong></p>
                        <button class="btn btn-success" onclick="confirmOrder()">Xác nhận đơn hàng</button>
                    </div>
                </div>
            </div>

            <div id="staff-payment" class="content-area">
                <div class="card">
                    <h3> Thanh toán</h3>
                    <div class="table-container" style="margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Bàn</th>
                                    <th>Món</th>
                                    <th>Tổng tiền</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="paymentTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="staff-menu" class="content-area">
             <div class="card">
                    <h3>Thực đơn</h3>
                      <div id="staffFullMenuGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                      </div>
                </div>
               </div>

            <div id="staff-shifts" class="content-area">
                <div class="card">
                    <h3>Ca làm việc</h3>
                    <div class="table-container" style="margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ngày</th>
                                    <th>Ca</th>
                                    <th>Giờ vào</th>
                                    <th>Giờ ra</th>
                                    <th>Tổng giờ</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody id="staffShiftsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="staff-leaves" class="content-area">
                <div class="cards-grid">
                    <div class="card">
                        <h3> Nộp đơn nghỉ phép</h3>
                        <div class="form-row">
                            <select class="form-control" id="leaveType">
                                <option>Chọn loại phép</option>
                                <option value="annual">Nghỉ phép thường niên</option>
                                <option value="sick">Nghỉ ốm</option>
                                <option value="personal">Nghỉ cá nhân</option>
                                <option value="emergency">Nghỉ khẩn cấp</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <input type="date" class="form-control" id="leaveFromDate">
                            <input type="date" class="form-control" id="leaveToDate">
                        </div>
                        <div class="form-row">
                            <textarea class="form-control" placeholder="Lý do nghỉ phép" id="leaveReason" rows="3"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="submitLeaveRequest()">Nộp đơn</button>
                    </div>
                    <div class="card">
                        
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h3>Lịch sử nghỉ phép</h3>
                    <div class="table-container" style="margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Loại phép</th>
                                    <th>Từ ngày</th>
                                    <th>Đến ngày</th>
                                    <th>Số ngày</th>
                                    <th>Lý do</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody id="staffLeaveHistoryBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    <!-- Modal đổi mật khẩu -->
<div id="changePasswordModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeChangePasswordModal()">&times;</span>
    <h3>Đổi mật khẩu</h3>
    <form id="changePasswordForm" onsubmit="event.preventDefault(); changePassword();">
      <div>
        <label>Mật khẩu cũ</label>
        <input type="password" id="oldPassword" required />
      </div>
      <div>
        <label>Mật khẩu mới</label>
        <input type="password" id="newPassword" required />
      </div>
      <div>
        <label>Nhập lại mật khẩu mới</label>
        <input type="password" id="confirmPassword" required />
      </div>
      <button type="submit">Xác nhận</button>
    </form>
  </div>
</div>




    <div id="addProductModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Thêm sản phẩm mới</h3>
            <button class="close-btn" onclick="closeModal('addProductModal')">&times;</button>
        </div>

        <div class="form-row">
            <div style="flex: 1; margin-right: 10px;">
                <label for="productName" style="font-weight: bold; display: block; margin-bottom: 5px;">Tên sản phẩm</label>
                <input type="text" class="form-control" placeholder="Nhập tên sản phẩm" id="productName" style="width: 100%;">
            </div>
            <div style="flex: 1;">
                <label for="productCategory" style="font-weight: bold; display: block; margin-bottom: 5px;">Loại sản phẩm</label>
                <select class="form-control" id="productCategory" style="width: 100%;">
                    <option value="">-- Chọn loại --</option>
                    <option value="DoUong">Đồ uống</option>
                    <option value="ThucAn">Thức ăn</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div style="flex: 1; margin-right: 10px;">
                <label for="productPrice" style="font-weight: bold; display: block; margin-bottom: 5px;">Giá bán (VNĐ)</label>
                <input type="number" class="form-control" placeholder="Nhập giá bán" id="productPrice" style="width: 100%;">
            </div>
            <div style="flex: 1;">
                <label for="productStatus" style="font-weight: bold; display: block; margin-bottom: 5px;">Trạng thái</label>
                <select class="form-control" id="productStatus" style="width: 100%;">
                    <option value="active">Hoạt động</option>
                    <option value="inactive">Ngưng bán</option>
                </select>
            </div>
        </div>

        <button class="btn btn-success" onclick="addProduct()" style="margin-top: 15px;">Thêm sản phẩm</button>
    </div>
</div>

    <div id="orderDetailModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Chi tiết hóa đơn #<span id="detailOrderId"></span></h3>
                <button class="close-btn" onclick="closeModal('orderDetailModal')">&times;</button>
            </div>
            
            <div class="order-info-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div>
                    <p><strong>Bàn số:</strong> <span id="detailTableName"></span></p>
                    <p><strong>Người tạo:</strong> <span id="detailStaffName"></span></p>
                </div>
                <div style="text-align: right;">
                    <p><strong>Ngày tạo:</strong> <span id="detailCreatedTime"></span></p>
                    <p><strong>Ngày thanh toán:</strong> <span id="detailPaymentTime"></span></p>
                </div>
            </div>

            <div class="table-container" style="margin-bottom: 20px; box-shadow: none; border: 1px solid #eee;">
                <table width="100%">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th>Tên món</th>
                            <th style="text-align: center;">SL</th>
                            <th style="text-align: right;">Đơn giá</th>
                            <th style="text-align: right;">Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody id="detailItemsBody">
                        </tbody>
                </table>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 2px solid #eee;">
                <div>
                    <strong>Trạng thái:</strong> <span id="detailStatusBadge"></span>
                </div>
                <div style="font-size: 1.2em;">
                    <strong>Tổng tiền:</strong> <span id="detailTotalAmount" style="color: #d97706;"></span>
                </div>
            </div>
        </div>
    </div>

    <div id="addStaffModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Thêm nhân viên mới</h3>
            <button class="close-btn" onclick="closeModal('addStaffModal')">&times;</button>
        </div>
        
        <div class="form-row">
            <div style="flex: 1; margin-right: 10px;">
                <label for="staffName" style="font-weight: bold; display: block; margin-bottom: 5px;">Họ và tên</label>
                <input type="text" class="form-control" placeholder="Nhập họ tên" id="staffName" style="width: 100%;">
            </div>
            <div style="flex: 1;">
                <label for="staffRole" style="font-weight: bold; display: block; margin-bottom: 5px;">Chức vụ</label>
                <select class="form-control" id="staffRole" style="width: 100%;">
                    <option value="">-- Chọn chức vụ --</option>
                    <option value="NhanVien">Nhân viên</option>
                    <option value="QuanLy">Quản lý</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div style="flex: 1;">
                <label for="staffEmail" style="font-weight: bold; display: block; margin-bottom: 5px;">Email/Tài khoản</label>
                <input type="email" class="form-control" placeholder="Nhập email" id="staffEmail" style="width: 100%;">
            </div>
        </div>

        <div class="form-row">
             <div style="flex: 1;">
                <label for="staffShift" style="font-weight: bold; display: block; margin-bottom: 5px;">Ca làm việc</label>
                <select class="form-control" id="staffShift" style="width: 100%;">
                    <option value="Ca sáng">Ca sáng</option>
                    <option value="Ca chiều">Ca chiều</option>
                    <option value="Ca tối">Ca tối</option>
                 </select>
             </div>
        </div>

        <button class="btn btn-success" onclick="addStaff()" style="margin-top: 15px;">Thêm nhân viên</button>
    </div>
</div>

    <div id="addTableModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Thêm bàn mới</h3>
            <button class="close-btn" onclick="closeModal('addTableModal')">&times;</button>
        </div>
        <div class="form-row">
            <input type="text" class="form-control" placeholder="Tên bàn" id="tableName" style="width: 100%;">
        </div>
        <button class="btn btn-success" onclick="addTable()">Thêm bàn</button>
    </div>
</div>

    <div id="editAttendanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Sửa thông tin chấm công</h3>
                <button class="close-btn" onclick="closeModal('editAttendanceModal')">&times;</button>
            </div>
            <input type="hidden" id="editAttId">
            
            <div class="form-row">
                <label for="editAttGioVao" style="width: 100%;">Giờ vào (YYYY-MM-DD HH:MM:SS):</label>
                <input type="text" class="form-control" id="editAttGioVao">
            </div>
            <div class="form-row">
                 <label for="editAttGioRa" style="width: 100%;">Giờ ra (YYYY-MM-DD HH:MM:SS):</label>
                <input type="text" class="form-control" id="editAttGioRa">
            </div>
             <div class="form-row">
                 <label for="editAttTrangThai" style="width: 100%;">Trạng thái:</label>
                <select id="editAttTrangThai" class="form-control">
                    <option value="Đúng giờ">Đúng giờ</option>
                    <option value="Đi trễ">Đi trễ</option>
                    <option value="Ngoài giờ">Ngoài giờ</option>
                    <option value="Chưa check-in">Chưa check-in</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="handleUpdateAttendance()">Cập nhật</button>
        </div>
    </div>

    <div id="editStaffModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Sửa thông tin nhân viên</h3>
            <button class="close-btn" onclick="closeModal('editStaffModal')">&times;</button>
        </div>
        <input type="hidden" id="editStaffId">
        
        <div class="form-row">
            <div style="flex: 1; margin-right: 10px;">
                <label for="editStaffName" style="font-weight: bold; display: block; margin-bottom: 5px;">Họ và tên</label>
                <input type="text" class="form-control" placeholder="Họ và tên" id="editStaffName" style="width: 100%;">
            </div>

            <div style="flex: 1;">
                <label for="editStaffRole" style="font-weight: bold; display: block; margin-bottom: 5px;">Vai trò</label>
                <select class="form-control" id="editStaffRole" style="width: 100%;">
                    <option value="NhanVien">Nhân viên</option>
                    <option value="QuanLy">Quản lý</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div style="flex: 1;">
                <label for="editStaffEmail" style="font-weight: bold; display: block; margin-bottom: 5px;">Email/Tài khoản</label>
                <input type="email" class="form-control" placeholder="Email/Tài khoản" id="editStaffEmail" style="width: 100%;">
            </div>
        </div>

        <div class="form-row">
             <div style="flex: 1;">
                <label for="editStaffShift" style="font-weight: bold; display: block; margin-bottom: 5px;">Ca làm việc</label>
                <select class="form-control" id="editStaffShift" style="width: 100%;">
                    <option value="Ca sáng">Ca sáng</option>
                    <option value="Ca chiều">Ca chiều</option>
                    <option value="Ca tối">Ca tối</option>
                 </select>
             </div>
        </div>

        <button class="btn btn-success" onclick="handleUpdateStaff()" style="margin-top: 15px;">Cập nhật</button>
    </div>
</div>

    <script>
    // Biến toàn cục
    let currentOrder = [];
    
    const API_BASE_URL = 'http://localhost:5000/api';
    let JWT_TOKEN = localStorage.getItem('token') || null;
    let CURRENT_USER_INFO = JSON.parse(localStorage.getItem('user_info')) || null;
    const REPORT_API = `${API_BASE_URL}/reports`; // Sửa đúng đường dẫn API report

    // =========================================================================
    // 1. CHỨC NĂNG ĐĂNG NHẬP (LOGIN)
    // =========================================================================
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const taiKhoan = document.getElementById('username').value;
        const matKhau = document.getElementById('password').value;

        // Gửi yêu cầu POST đến API login
        fetch(`${API_BASE_URL}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ taiKhoan, matKhau })
        })
        .then(response => {
            // Kiểm tra mã trạng thái HTTP (2xx, 4xx, 5xx)
            if (!response.ok) {
                return response.json().then(error => { throw new Error(error.message || 'Đăng nhập thất bại'); });
            }
            return response.json();
        })
        .then(data => {
            // Xử lý dữ liệu thành công
            const token = data.token;
            const user = data.user; 
            
            // ⭐️ LƯU TOKEN VÀ THÔNG TIN NGƯỜI DÙNG
            localStorage.setItem('token', token);
            localStorage.setItem('user_info', JSON.stringify(user));
            JWT_TOKEN = token;
            CURRENT_USER_INFO = user;

            // Chuyển hướng giao diện
            navigateToDashboard(user.vaiTro);
            showToast('Đăng nhập thành công!', 'success');
        })
        .catch(error => {
            // Xử lý lỗi
            console.error('Lỗi đăng nhập:', error);
            showToast(error.message || 'Tên đăng nhập hoặc mật khẩu không đúng!', 'error');
        });
    });

    function navigateToDashboard(vaiTro) {
        document.getElementById('loginSection').style.display = 'none';
        
        // Cập nhật thông tin User trên giao diện
        const userRole = vaiTro.toLowerCase().includes('admin') || vaiTro.toLowerCase().includes('quanly') ? 'admin' : 'staff';
        
        // Ẩn tất cả dashboard
        document.querySelectorAll('.dashboard').forEach(d => d.classList.remove('active'));
        
        if (userRole === 'admin') {
            document.getElementById('adminDashboard').classList.add('active');
            // Kích hoạt tab đầu tiên (Sản phẩm)
            showAdminContent('products', document.querySelector('#adminDashboard .nav-tab.active')); 
        } else {
            document.getElementById('staffDashboard').classList.add('active');
            // Kích hoạt tab đầu tiên (Tạo order)
            showStaffContent('orders', document.querySelector('#staffDashboard .nav-tab.active'));
        }
    }

    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('user_info');
        JWT_TOKEN = null;
        CURRENT_USER_INFO = null;
        
        document.getElementById('adminDashboard').classList.remove('active');
        document.getElementById('staffDashboard').classList.remove('active');
        document.getElementById('loginSection').style.display = 'flex';
        
        document.getElementById('loginForm').reset();
        showToast('Đã đăng xuất!', 'success');
    }

    // =========================================================================
    // 2. CHỨC NĂNG API VÀ ĐIỀU HƯỚNG
    // =========================================================================

    // Hàm gọi API chung (gửi token)
    async function apiCall(endpoint, method = 'GET', data = null) {
        if (!JWT_TOKEN) {
            showToast('Phiên làm việc hết hạn. Vui lòng đăng nhập lại.', 'error');
            logout();
            throw new Error("Token is missing");
        }

        const headers = {
            'Authorization': `Bearer ${JWT_TOKEN}`,
        };

        if (data) {
            headers['Content-Type'] = 'application/json';
        }

        const config = {
            method: method,
            headers: headers,
            body: data ? JSON.stringify(data) : null
        };

        const url = `${API_BASE_URL}${endpoint}`;
        
        try {
            const response = await fetch(url, config);
            
            let responseData;
            const text = await response.text();
            try {
                responseData = JSON.parse(text);
            } catch (e) {
                responseData = { message: "Thao tác thành công." };
            }

            if (response.status === 401 || response.status === 403) {
                // Token không hợp lệ hoặc hết hạn
                showToast(responseData.message || 'Xác thực thất bại. Vui lòng đăng nhập lại.', 'error');
                logout();
                throw new Error(responseData.message);
            }

            if (!response.ok) {
                throw new Error(responseData.message || `Lỗi API: ${response.status}`);
            }

            return responseData;
        } catch (error) {
            console.error(`Lỗi gọi API ${endpoint}:`, error);
            showToast(error.message, 'error'); 
            throw error;
        }
    }

    // Kiểm tra trạng thái login khi tải trang
    (function checkLoginStatus() {
        if (JWT_TOKEN && CURRENT_USER_INFO) {
            navigateToDashboard(CURRENT_USER_INFO.vaiTro);
        }
    })();

    // Điều hướng tab cho Quản lý và tải dữ liệu tương ứng
    function showAdminContent(contentId, clickedTab) {
        // Ẩn tất cả các khu vực nội dung
        const contentAreas = document.querySelectorAll('#adminDashboard .content-area');
        contentAreas.forEach(area => area.classList.remove('active'));
        
        // Hiển thị nội dung được chọn
        const activeArea = document.getElementById(`admin-${contentId}`);
        if (activeArea) {
            activeArea.classList.add('active');
        }
        
        // Cập nhật tab đang hoạt động (SỬA LỖI 2: logic thêm class active)
        if(clickedTab) { 
            const tabs = document.querySelectorAll('#adminDashboard .nav-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            clickedTab.classList.add('active');
        }

        // Tải dữ liệu tương ứng khi bấm tab
        switch(contentId) {
            case 'products':
                loadProducts();
                break;
            case 'staff':
                loadStaff();
                break;
            case 'orders':
                loadOrders();
                break;
            case 'revenue':
                // loadRevenueReport(); // Gọi khi cần xem báo cáo
                break;
            case 'attendance':
            // Gọi hàm tải bộ lọc nhân viên
            if (typeof loadEmployeeFilter === 'function') {
                loadEmployeeFilter();
            }
            // Gọi hàm tải báo cáo chấm công
            if (typeof loadAttendanceReport === 'function') {
                loadAttendanceReport();
            }
            break;
            case 'leaves':
                loadLeaves();
                break;
            case 'tables':
                loadTables();
                break;
        }
    }

    // Điều hướng tab cho Nhân viên và tải dữ liệu tương ứng
    function showStaffContent(contentId, clickedTab) {
        // Ẩn tất cả các khu vực nội dung
        const contentAreas = document.querySelectorAll('#staffDashboard .content-area');
        contentAreas.forEach(area => area.classList.remove('active'));
        
        // Hiển thị nội dung được chọn
        const activeArea = document.getElementById(`staff-${contentId}`);
        if (activeArea) {
            activeArea.classList.add('active');
        }
        
       // Cập nhật tab đang hoạt động (SỬA LỖI 2: logic thêm class active)
        if(clickedTab) {
             const tabs = document.querySelectorAll('#staffDashboard .nav-tab');
             tabs.forEach(tab => tab.classList.remove('active'));
             clickedTab.classList.add('active');
        }

        // Tải dữ liệu tương ứng khi bấm tab
        switch(contentId) {
            case 'orders':
                loadTablesForStaff();
                loadMenuForStaff();
                break;
            case 'payment':
                loadPayments();
                break;
            case 'menu':
                loadFullMenu();
                break;
            case 'shifts':
                loadMyShifts();
                break;
            case 'leaves':
                loadMyLeaveHistory();
                break;
        }
    }

    // =========================================================================
    // 3. CÁC HÀM TẢI DỮ LIỆU (LOAD DATA)
    // =========================================================================

    // (Hàm tải dữ liệu) Tải danh sách sản phẩm
    async function loadProducts() {
    try {
        const products = await apiCall('/products', 'GET');
        const tbody = document.getElementById('productsTableBody');
        tbody.innerHTML = ''; 

        products.forEach(product => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${product.tenSP}</td>
                <td>${product.loai}</td>
                <td>${product.gia.toLocaleString()} VNĐ</td>
                <td><span class="status-badge status-active">Hoạt động</span></td>
                <td>
                    <button class="btn btn-warning btn-edit">Sửa</button>
                    <button class="btn btn-danger btn-delete">Xóa</button>
                </td>
            `;

            row.querySelector(".btn-edit").addEventListener("click", () => openEditModal(product));
            row.querySelector(".btn-delete").addEventListener("click", () => deleteProduct(product.maSP));
        });

    } catch (error) {
        console.error("Lỗi tải sản phẩm:", error);
    }
}



    // (Hàm tải dữ liệu) Tải danh sách nhân viên
    async function loadStaff() {
        try {
            const staffList = await apiCall('/users', 'GET');
            const tbody = document.getElementById('staffTableBody'); 
            tbody.innerHTML = ''; 

            staffList.forEach(staff => {
                const roleClass = staff.vaiTro.toLowerCase().includes('quanly') ? 'role-admin' : 'role-staff';
                const row = tbody.insertRow();
                
                // ⭐ SỬA LẠI: Gắn sự kiện onclick vào 2 nút
                row.innerHTML = `
                    <td>${staff.tenNV}</td>
                    <td><span class="${roleClass}">${staff.vaiTro}</span></td>
                    <td>${staff.taiKhoan}</td>
                    <td>${staff.caLamViec || 'Chưa xếp'}</td>
                    <td><span class="status-badge status-active">Hoạt động</span></td>
                    <td>
                        <button class="btn btn-warning" onclick='showEditStaffModal(${JSON.stringify(staff)})'>Sửa</button>
                        <button class="btn btn-danger" onclick="deleteStaff(${staff.maNV})">Xóa</button>
                        <button class="btn btn-secondary" onclick="resetStaffPassword(${staff.maNV})">Đặt lại mật khẩu</button>

                    </td>
                `;
            });
        } catch (error) {
            console.error("Lỗi tải nhân viên:", error);
        }
    }

    // 1. Hàm mở modal Sửa và điền dữ liệu cũ
    function showEditStaffModal(staff) {
        document.getElementById('editStaffId').value = staff.maNV;
        document.getElementById('editStaffName').value = staff.tenNV;
        document.getElementById('editStaffRole').value = staff.vaiTro;
        document.getElementById('editStaffEmail').value = staff.taiKhoan;
        document.getElementById('editStaffShift').value = staff.caLamViec || 'Ca sáng';

        document.getElementById('editStaffModal').classList.add('active');
    }

    // 2. Hàm gọi API Cập nhật nhân viên
    async function handleUpdateStaff() {
        const id = document.getElementById('editStaffId').value;
        const name = document.getElementById('editStaffName').value;
        const role = document.getElementById('editStaffRole').value;
        const email = document.getElementById('editStaffEmail').value;
        const password = document.getElementById('editStaffPassword').value;
        const shift = document.getElementById('editStaffShift').value;

        const updateData = {
            tenNV: name,
            vaiTro: role,
            taiKhoan: email,
            caLamViec: shift
        };

        // Chỉ gửi mật khẩu nếu người dùng có nhập
        if (password) {
            updateData.matKhau = password;
        }

        try {
            await apiCall(`/users/${id}`, 'PUT', updateData);
            showToast('Cập nhật nhân viên thành công!', 'success');
            closeModal('editStaffModal');
            loadStaff(); // Tải lại bảng
        } catch (error) {
            console.error("Lỗi cập nhật nhân viên:", error);
        }
    }

    // 3. Hàm gọi API Xóa nhân viên
    async function deleteStaff(id) {
        if (!confirm("Bạn có chắc chắn muốn xóa nhân viên này? Hành động này không thể hoàn tác.")) {
            return;
        }
        
        try {
            await apiCall(`/users/${id}`, 'DELETE');
            showToast('Đã xóa nhân viên!', 'success');
            loadStaff(); // Tải lại bảng
        } catch (error) {
            console.error("Lỗi xóa nhân viên:", error);
        }
    }

    // (Hàm tải dữ liệu) Tải danh sách đơn hàng
    // Biến toàn cục để lưu danh sách đơn hàng gốc
let allOrdersList = [];

// 1. Hàm tải đơn hàng từ Server
async function loadOrders() {
    try {
        const orders = await apiCall('/orders', 'GET');
        
        // Lưu dữ liệu vào biến toàn cục
        allOrdersList = orders;

        // Hiển thị toàn bộ danh sách
        renderOrderTable(allOrdersList);

    } catch (error) {
        console.error("Lỗi tải đơn hàng:", error);
    }
}

// 2. Hàm hiển thị bảng (Tách riêng để tái sử dụng khi search)
function renderOrderTable(orders) {
    const tbody = document.getElementById('ordersTableBody');
    tbody.innerHTML = ''; 

    if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Không tìm thấy đơn hàng nào</td></tr>';
        return;
    }

    orders.forEach(order => {
        const row = tbody.insertRow();
        
        let statusBadge = 'status-pending';
        let statusText = order.trangThai;
        if (order.trangThai === 'DaThanhToan') {
            statusBadge = 'status-active'; 
            statusText = 'Đã thanh toán';
        } else if (order.trangThai === 'Huy') {
            statusBadge = 'status-rejected'; 
            statusText = 'Đã hủy';
        } else {
            statusBadge = 'status-warning'; 
            statusText = 'Đang xử lý';
        }

        row.innerHTML = `
            <td>#${order.maDH}</td>
            <td>Bàn ${order.maBan}</td>
            <td style="font-weight: bold;">${order.tongTien.toLocaleString()} VNĐ</td>
            <td><span class="status-badge ${statusBadge}">${statusText}</span></td>
            <td>
                <button class="btn btn-primary" onclick='showOrderDetail(${JSON.stringify(order)})'>Chi tiết</button>
                
                <button onclick="downloadInvoiceByOrderId(${order.maDH})" style="padding:5px 10px; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer; margin-left: 5px;">
                    In hóa đơn
                </button>
            </td>
        `;
    });
}

// 3. Hàm Tìm kiếm
function searchOrder() {
    const keyword = document.getElementById('orderSearchInput').value.trim().toLowerCase();
    
    if (!keyword) {
        renderOrderTable(allOrdersList); // Nếu rỗng thì hiện tất cả
        return;
    }

    // Lọc danh sách theo Mã đơn (convert sang string để so sánh)
    const filteredOrders = allOrdersList.filter(order => 
        order.maDH.toString().includes(keyword)
    );

    renderOrderTable(filteredOrders);
}

// 4. Hàm Làm mới (Reset)
function resetOrderSearch() {
    document.getElementById('orderSearchInput').value = '';
    renderOrderTable(allOrdersList);
}

    // (Hàm MỚI: Hiển thị chi tiết trong Modal)
    function showOrderDetail(order) {
        // 1. Điền thông tin chung
        document.getElementById('detailOrderId').textContent = order.maDH;
        document.getElementById('detailTableName').textContent = `Bàn ${order.maBan}`;
        // Hiển thị tên nhân viên nếu có, ngược lại hiện ID
        const tenNV = order.NhanVien ? order.NhanVien.tenNV : (order.maNV || 'N/A'); 
        document.getElementById('detailStaffName').textContent = tenNV; 
        
        // 2. Xử lý thời gian (ĐÃ SỬA LẠI)
        const createdTime = new Date(order.thoiGian).toLocaleString('vi-VN');
        document.getElementById('detailCreatedTime').textContent = createdTime;
        
        let paymentTimeText = '---';
        if (order.trangThai === 'Huy') {
            paymentTimeText = 'Đã hủy';
        } else if (order.ThanhToan && order.ThanhToan.thoiGian) {
            // Ưu tiên 1: Lấy từ bảng ThanhToan (nếu Backend đã include)
            paymentTimeText = new Date(order.ThanhToan.thoiGian).toLocaleString('vi-VN');
        } else if (order.trangThai === 'DaThanhToan') {
            // Ưu tiên 2: Nếu đã thanh toán mà chưa load được bảng ThanhToan, lấy ngày cập nhật đơn
            paymentTimeText = new Date(order.updatedAt).toLocaleString('vi-VN');
        } else {
            paymentTimeText = 'Chưa thanh toán';
        }
        document.getElementById('detailPaymentTime').textContent = paymentTimeText;

        // 3. Điền danh sách món ăn
        const tbody = document.getElementById('detailItemsBody');
        tbody.innerHTML = '';
        
        if (order.ChiTietDonHangs && order.ChiTietDonHangs.length > 0) {
            order.ChiTietDonHangs.forEach(item => {
                const tr = document.createElement('tr');
                const donGia = item.SanPham ? item.SanPham.gia : 0;
                const tenSP = item.SanPham ? item.SanPham.tenSP : 'Sản phẩm đã xóa';
                const thanhTien = donGia * item.soLuong;

                tr.innerHTML = `
                    <td>${tenSP}</td>
                    <td style="text-align: center;">${item.soLuong}</td>
                    <td style="text-align: right;">${donGia.toLocaleString()}</td>
                    <td style="text-align: right; font-weight: bold;">${thanhTien.toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Không có món nào</td></tr>';
        }

        // 4. Trạng thái và Tổng tiền
        const statusSpan = document.getElementById('detailStatusBadge');
        let statusClass = 'status-pending';
        let statusText = order.trangThai;
        
        if (order.trangThai === 'DaThanhToan') {
            statusClass = 'status-active';
            statusText = 'Đã thanh toán';
        } else if (order.trangThai === 'Huy') {
            statusClass = 'status-rejected';
            statusText = 'Đã hủy';
        } else if (order.trangThai === 'DangXuLy') {
             statusClass = 'status-warning'; // Màu vàng
             statusText = 'Đang xử lý';
        }
        
        statusSpan.className = `status-badge ${statusClass}`;
        statusSpan.textContent = statusText;
        
        document.getElementById('detailTotalAmount').textContent = `${order.tongTien.toLocaleString()} VNĐ`;

        // 5. Mở Modal
        document.getElementById('orderDetailModal').classList.add('active');
    }

function printOrder() {
    const orderId = document.getElementById('detailOrderId').textContent;
    const tableName = document.getElementById('detailTableName').textContent;
    const staffName = document.getElementById('detailStaffName').textContent;
    const createdTime = document.getElementById('detailCreatedTime').textContent;
    const paymentTime = document.getElementById('detailPaymentTime').textContent;
    const status = document.getElementById('detailStatusBadge').textContent;
    const totalAmount = document.getElementById('detailTotalAmount').textContent;

    const tbody = document.getElementById('detailItemsBody');
    let itemsText = '';
    for (let row of tbody.rows) {
        const cells = row.cells;
        itemsText += `${cells[0].textContent}\tSL: ${cells[1].textContent}\tĐơn giá: ${cells[2].textContent}\tThành tiền: ${cells[3].textContent}\r\n`;
    }

    const text = `
HÓA ĐƠN #${orderId}
========================
Bàn: ${tableName}
Người tạo: ${staffName}
Ngày tạo: ${createdTime}
Ngày thanh toán: ${paymentTime}
Trạng thái: ${status}

Danh sách món:
${itemsText}

Tổng tiền: ${totalAmount}
========================
`;

   // 3. TẠO FILE VÀ TẢI VỀ (Phần thay đổi)
    
    // Tạo đối tượng Blob chứa nội dung text
    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
    
    // Tạo đường dẫn URL ảo cho blob này
    const url = window.URL.createObjectURL(blob);
    
    // Tạo một thẻ a ẩn để thực hiện việc download
    const a = document.createElement('a');
    a.href = url;
    
    // Đặt tên file khi tải về (Ví dụ: HoaDon_123.txt)
    a.download = `HoaDon_${orderId}.txt`;
    
    // Thêm thẻ a vào body (cần thiết cho một số trình duyệt như Firefox)
    document.body.appendChild(a);
    
    // Tự động click vào thẻ a
    a.click();
    
    // Dọn dẹp: xóa thẻ a và thu hồi URL để giải phóng bộ nhớ
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}




    // (Hàm tải dữ liệu) Tải danh sách điểm danh
    async function loadAttendance() {
        try {
            const records = await apiCall('/attendance', 'GET');
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = ''; 

            if (records.length === 0) {
                // Đảm bảo colspan là 8 (Nhân viên, Chức vụ, Ngày, Giờ vào, Giờ ra, Tổng giờ, Trạng thái, Thao tác)
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center;">Không có dữ liệu điểm danh</td></tr>`;
                return;
            }

            records.forEach(record => {
                const row = tbody.insertRow();
                
                const gioVao = record.gioVao ? new Date(record.gioVao).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) : '...';
                const gioRa = record.gioRa ? new Date(record.gioRa).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) : '...';
                
                let tongGio = '...'; 
                if (record.gioVao && record.gioRa) { 
                    const gioVaoDate = new Date(record.gioVao);
                    const gioRaDate = new Date(record.gioRa);
                    const diffMs = gioRaDate - gioVaoDate; 
                    if (diffMs > 0) { 
                        const diffHours = diffMs / (1000 * 60 * 60); 
                        tongGio = `${diffHours.toFixed(0)} tiếng`; 
                    }
                }
                
                let statusBadge = 'status-active'; 
                if (record.trangThaiTinhToan === 'Đi trễ') statusBadge = 'status-pending';
                if (record.trangThaiTinhToan === 'Chưa check-in') statusBadge = 'status-inactive';
                if (record.trangThaiTinhToan === 'Không có ca') statusBadge = 'status-inactive';

                row.innerHTML = `
                    <td>${record.tenNV}</td>
                    <td>${record.vaiTro}</td>
                    <td>${new Date(record.ngay).toLocaleDateString('vi-VN')}</td>
                    <td>${gioVao}</td>
                    <td>${gioRa}</td>
                    <td>${tongGio}</td>
                    <td><span class="status-badge ${statusBadge}">${record.trangThaiTinhToan}</span></td>
                    <td>
                        <button class="btn btn-warning" onclick='showEditAttendanceModal(${JSON.stringify(record)})'>Sửa</button>
                        <button class="btn btn-danger" onclick="deleteAttendance(${record.maCC})">Xóa</button>
                    </td>
                `;
            });
        } catch (error) {
            console.error("Lỗi tải điểm danh:", error);
            document.getElementById('attendanceTableBody').innerHTML = `<tr><td colspan="8" style="text-align: center;">Lỗi tải dữ liệu.</td></tr>`;
        }
    }

    // (Hàm tải dữ liệu) Tải danh sách nghỉ phép (cho Admin)
    async function loadLeaves() {
        try {
            const leaveList = await apiCall('/leaves', 'GET');
            const tbody = document.getElementById('leavesTableBody');
            tbody.innerHTML = ''; 

            if (leaveList.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center;">Không có đơn nghỉ phép nào</td></tr>`;
                return;
            }

            leaveList.forEach(leave => {
                const row = tbody.insertRow();
                let statusBadge = 'status-pending'; 
                if (leave.trangThai === 'DaDuyet') statusBadge = 'status-approved';
                if (leave.trangThai === 'TuChoi') statusBadge = 'status-rejected';

                const tuNgayDate = new Date(leave.tuNgay);
                const denNgayDate = new Date(leave.denNgay);
                const diffTime = Math.abs(denNgayDate - tuNgayDate); 
                const soNgay = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

                row.innerHTML = `
                    <td>${leave.NhanVien ? leave.NhanVien.tenNV : 'N/A'}</td>
                    <td>${leave.loaiPhep}</td>
                    <td>${tuNgayDate.toLocaleDateString('vi-VN')}</td>
                    <td>${denNgayDate.toLocaleDateString('vi-VN')}</td>
                    <td>${soNgay} ngày</td>
                    <td>${leave.lyDo}</td>
                    <td><span class="status-badge ${statusBadge}">${leave.trangThai}</span></td>
                    <td>
                        <button class="btn btn-success" onclick="approveLeave(${leave.maNP})">Duyệt</button>
                        <button class="btn btn-danger" onclick="rejectLeave(${leave.maNP})">Từ chối</button>
                    </td>
                `;
            });
        } catch (error) {
            console.error("Lỗi tải nghỉ phép:", error);
        }
    }

    // (Hàm tải dữ liệu) Tải danh sách bàn
    async function loadTables() {
    try {
        const tables = await apiCall('/tables', 'GET');
        const grid = document.getElementById('adminTableGrid');
        grid.innerHTML = ''; 

        tables.forEach(table => {
            let statusClass, statusBadge, statusText;
            
            // Logic màu sắc (Giữ nguyên của bạn)
            if (table.trangThai === 'Trong') {
                statusClass = 'dcfce7'; statusBadge = 'status-active'; statusText = 'Trống';
            } else if (table.trangThai === 'DangPhucVu') {
                statusClass = 'fee2e2'; statusBadge = 'status-rejected'; statusText = 'Có khách';
            } else { 
                statusClass = 'fef3c7'; statusBadge = 'status-pending'; statusText = 'Đặt trước';
            }

            const tableDiv = document.createElement('div');
            tableDiv.className = 'table-item';
            // Thêm position: relative để căn chỉnh nếu cần
            tableDiv.style = `background: #${statusClass}; padding: 15px; border-radius: 10px; text-align: center; position: relative;`;
            
            tableDiv.innerHTML = `
                <h4 style="margin-bottom: 5px;">${table.tenBan}</h4>
                <span class="status-badge ${statusBadge}" style="font-size: 12px;">${statusText}</span>
                
                <div style="margin-top: 15px; display: flex; gap: 5px; justify-content: center;">
                    <button class="btn btn-warning" 
                        style="padding: 4px 10px; font-size: 12px;" 
                        onclick="openEditTableModal(${table.maBan}, '${table.tenBan}')">
                        Sửa
                    </button>

                    <button class="btn btn-danger" 
                        style="padding: 4px 10px; font-size: 12px;" 
                        onclick="deleteTable(${table.maBan})">
                        Xóa
                    </button>
                </div>
            `;
            grid.appendChild(tableDiv);
        });
    } catch (error) {
        console.error("Lỗi tải bàn:", error);
    }
}

    // (Hàm tải dữ liệu) Tải danh sách bàn cho nhân viên (vào dropdown)
    async function loadTablesForStaff() {
        try {
            const tables = await apiCall('/tables', 'GET');
            const select = document.getElementById('orderTable');
            select.innerHTML = '<option value="">Chọn bàn</option>'; 

            tables.forEach(table => {
                const option = document.createElement('option');
                option.value = table.maBan;
                option.textContent = `${table.tenBan} (${table.trangThai})`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error("Lỗi tải bàn cho nhân viên:", error);
        }
    }
    
    // (Hàm tải dữ liệu) Tải menu cho nhân viên (để tạo order)
    async function loadMenuForStaff() {
        try {
            const products = await apiCall('/products', 'GET');
            const grid = document.getElementById('staffMenuGrid');
            grid.innerHTML = ''; 

            products.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.className = 'menu-item';
                productDiv.style = "border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; cursor: pointer;";
                
                productDiv.setAttribute('onclick', `addToOrder(${JSON.stringify(product)})`);
                
                productDiv.innerHTML = `
                    <strong>${product.tenSP}</strong>
                    <p>${product.gia.toLocaleString()} VNĐ</p>
                `;
                grid.appendChild(productDiv);
            });
        } catch (error) {
            console.error("Lỗi tải menu:", error);
        }
    }

    // (Hàm tải dữ liệu) Tải thực đơn đầy đủ (cho nhân viên xem)
    async function loadFullMenu() {
        try {
            const products = await apiCall('/products', 'GET');
            const grid = document.getElementById('staffFullMenuGrid');
            grid.innerHTML = ''; 

            const categories = {};
            products.forEach(product => {
                if (!categories[product.loai]) {
                    categories[product.loai] = []; 
                }
                categories[product.loai].push(product);
            });

            for (const categoryName in categories) {
                const productsInCategory = categories[categoryName];
                
                let itemsHtml = '<ul style="list-style: none; padding: 0; margin-top: 15px;">';
                productsInCategory.forEach(item => {
                    itemsHtml += `
                        <li style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>${item.tenSP}</span>
                            <strong>${item.gia.toLocaleString()} VNĐ</strong>
                        </li>
                    `;
                });
                itemsHtml += '</ul>';

                const categoryDiv = document.createElement('div');
                categoryDiv.style = "border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; background: #ffffff;";
                categoryDiv.innerHTML = `
                    <h4>${categoryName}</h4>
                    ${itemsHtml}
                `;
                grid.appendChild(categoryDiv);
            }

        } catch (error) {
            console.error("Lỗi tải thực đơn:", error);
            document.getElementById('staffFullMenuGrid').innerHTML = '<p>Không thể tải thực đơn.</p>';
        }
    }

    // (Hàm tải dữ liệu) Tải ca làm việc của nhân viên
    async function loadMyShifts() {
    const tbody = document.getElementById('staffShiftsTableBody');
    
    // 1. Thêm trạng thái Loading để người dùng biết đang tải
    tbody.innerHTML = `<tr><td colspan="6" style="text-align: center;">Đang tải dữ liệu...</td></tr>`;

    try {
        const myShifts = await apiCall('/shifts/my', 'GET');

        // Kiểm tra dữ liệu rỗng
        if (!myShifts || myShifts.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align: center;">Bạn chưa được xếp ca làm việc.</td></tr>`;
            return;
        }

        // 2. Sử dụng map() để tạo chuỗi HTML (Tối ưu hiệu suất DOM)
        const htmlRows = myShifts.map(shift => {
            const start = new Date(shift.gioBatDau);
            const end = new Date(shift.gioKetThuc);

            // Format giờ:phút (Ví dụ: 08:00)
            // Lưu ý: Đã bỏ 'timeZone: UTC' để hiển thị theo giờ máy tính người dùng cho chính xác. 
            // Nếu backend của bạn lưu giờ UTC chuẩn thì trình duyệt sẽ tự đổi sang giờ VN.
            const timeOpt = { hour: '2-digit', minute: '2-digit', hour12: false };
            const gioVao = start.toLocaleTimeString('vi-VN', timeOpt);
            const gioKetThuc = end.toLocaleTimeString('vi-VN', timeOpt);
            
            // Format ngày (Ví dụ: 23/11/2025)
            const ngayLam = new Date(shift.ngayLamViec).toLocaleDateString('vi-VN');

            // 3. Tính toán thời gian chính xác hơn (Lấy 1 số thập phân, ví dụ 4.5 tiếng)
            const diffMs = end - start;
            const diffHours = (diffMs / (1000 * 60 * 60)).toFixed(1); 

            return `
                <tr>
                    <td>${ngayLam}</td>
                    <td>${shift.tenCa}</td>
                    <td>${gioVao}</td>
                    <td>${gioKetThuc}</td>
                    <td>${diffHours} tiếng</td>
                    <td><span class="status-badge status-active">Đã xếp lịch</span></td>
                </tr>
            `;
        }).join(''); // Nối tất cả các dòng lại thành 1 chuỗi

        // 4. Cập nhật DOM 1 lần duy nhất
        tbody.innerHTML = htmlRows;

    } catch (error) {
        console.error("Lỗi tải ca làm việc:", error);
        tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: red;">Lỗi tải dữ liệu. Vui lòng thử lại.</td></tr>`;
    }
}

    // (Hàm tải dữ liệu) Tải lịch sử nghỉ phép của nhân viên
    async function loadMyLeaveHistory() {
        try {
            const myLeaves = await apiCall('/leaves/my', 'GET');
            const tbody = document.getElementById('staffLeaveHistoryBody');
            tbody.innerHTML = '';

            if (myLeaves.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center;">Bạn chưa có lịch sử nghỉ phép.</td></tr>`;
                return;
            }

            myLeaves.forEach(leave => {
                const row = tbody.insertRow();
                let statusBadge = 'status-pending';
                if (leave.trangThai === 'DaDuyet') statusBadge = 'status-approved';
                if (leave.trangThai === 'TuChoi') statusBadge = 'status-rejected';

                const tuNgayDate = new Date(leave.tuNgay);
                const denNgayDate = new Date(leave.denNgay);

                const diffTime = Math.abs(denNgayDate - tuNgayDate); 
                const soNgay = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 

                row.innerHTML = `
                    <td>${leave.loaiPhep}</td>
                    <td>${tuNgayDate.toLocaleDateString('vi-VN')}</td>
                    <td>${denNgayDate.toLocaleDateString('vi-VN')}</td>
                    <td>${soNgay} ngày</td>
                    <td>${leave.lyDo}</td>
                    <td><span class="status-badge ${statusBadge}">${leave.trangThai}</span></td>
                `;
            });
        } catch (error) {
            console.error("Lỗi tải lịch sử nghỉ phép:", error);
            document.getElementById('staffLeaveHistoryBody').innerHTML = `<tr><td colspan="6" style="text-align: center;">Lỗi tải dữ liệu.</td></tr>`;
        }
    }

    // (Hàm tải dữ liệu) Tải danh sách nhân viên cho dropdown (để xếp ca)
    async function loadEmployeesForShiftDropdown() {
        try {
            const staffList = await apiCall('/users', 'GET');
            const select = document.getElementById('shiftEmployee');
            select.innerHTML = '<option value="">Chọn nhân viên...</option>';
            staffList.forEach(staff => {
                select.innerHTML += `<option value="${staff.maNV}">${staff.tenNV}</option>`;
            });
        } catch (error) { console.error("Lỗi tải NV cho dropdown:", error); }
    }

    // (Hàm tải dữ liệu) Tải danh sách đơn hàng chờ thanh toán
    async function loadPayments() {
    try {
        const orders = await apiCall('/orders', 'GET');
        const tbody = document.getElementById('paymentTableBody');
        tbody.innerHTML = '';

        // Lọc đơn đang chờ thanh toán
        const pendingOrders = orders.filter(o => o.trangThai === 'DangXuLy');

        if (pendingOrders.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Không có đơn hàng nào chờ thanh toán</td></tr>`;
            return;
        }

        pendingOrders.forEach(order => {
            const row = tbody.insertRow();
            
            // Lấy danh sách món
            const monAn = order.ChiTietDonHangs 
                ? order.ChiTietDonHangs.map(item => item.SanPham ? item.SanPham.tenSP : 'Món đã xóa').join(', ') 
                : '(Chưa có chi tiết)';

            row.innerHTML = `
                <td>Bàn ${order.maBan}</td>
                <td>${order.tenKhachHang || '(Khách lẻ)'}</td>
                <td>${monAn}</td>
                <td>${order.tongTien.toLocaleString()} VNĐ</td>
                <td>
                    <button class="btn btn-success" onclick="processPayment(${order.maDH}, ${order.maBan})">Đã thanh toán</button>
                    
                    <button class="btn btn-danger" onclick="cancelOrder(${order.maDH})">Hủy</button>
                </td>
            `;
        });
    } catch (error) {
        console.error("Lỗi tải danh sách thanh toán:", error);
    }
}
    
    // 1. Hàm hỗ trợ tính ngày cho các nút bấm
function filterRevenue(type) {
    const today = new Date();
    let fromDate = new Date();
    let toDate = new Date();

    if (type === 'today') {
        // Từ hôm nay đến hôm nay
        fromDate = today;
        toDate = today;
    } else if (type === 'week') {
        // Tuần này: Từ thứ 2 đầu tuần đến hôm nay
        const day = today.getDay(); // 0 là CN, 1 là T2...
        const diff = today.getDate() - day + (day === 0 ? -6 : 1); // Điều chỉnh về thứ 2
        fromDate.setDate(diff);
        toDate = today;
    } else if (type === 'month') {
        // Tháng này: Từ ngày 1 đến hôm nay
        fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
        toDate = today;
    }

    // Format ngày thành YYYY-MM-DD để gán vào input type="date"
    const formatDate = (date) => date.toISOString().split('T')[0];

    document.getElementById("revFrom").value = formatDate(fromDate);
    document.getElementById("revTo").value = formatDate(toDate);

    // Tự động tải báo cáo luôn sau khi chọn
    loadRevenueReport();
}

// 2. Cập nhật hàm loadRevenueReport
async function loadRevenueReport() {
    const fromDate = document.getElementById("revFrom").value;
    const toDate = document.getElementById("revTo").value;
    
    // --- PHẦN 1: TẢI DOANH THU (Code cũ của bạn, giữ nguyên logic) ---
    let query = "?type=date";
    if (fromDate) query += `&from=${fromDate}`;
    if (toDate) query += `&to=${toDate}`;

    try {
        // Gọi API Doanh thu
        const resRevenue = await fetch(`${REPORT_API}/revenue${query}`, {
            headers: { 
                "Content-Type": "application/json",
                "Authorization": `Bearer ${localStorage.getItem("token")}`
            }
        });

        if (resRevenue.ok) {
            const data = await resRevenue.json();
            const tbody = document.getElementById("revenueTableBody");
            tbody.innerHTML = ""; 
            
            let totalSum = 0;
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="2" style="text-align:center;">Không có dữ liệu</td></tr>`;
            } else {
                data.forEach(item => {
                    totalSum += item.doanhThu;
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${item.ngay}</td>
                        <td style="font-weight: bold;">${parseInt(item.doanhThu).toLocaleString('vi-VN')} đ</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            document.getElementById("totalRevenueSum").innerText = totalSum.toLocaleString('vi-VN') + " VNĐ";
        }

        // --- PHẦN 2: TẢI TOP SẢN PHẨM (Code Mới thêm) ---
        // Tạo query string cho API top products
        let prodQuery = "?top=10"; // Lấy top 10
        if (fromDate) prodQuery += `&from=${fromDate}`;
        if (toDate) prodQuery += `&to=${toDate}`;

        const resProd = await fetch(`${REPORT_API}/top-products${prodQuery}`, {
             headers: { 
                "Content-Type": "application/json",
                "Authorization": `Bearer ${localStorage.getItem("token")}`
            }
        });

        if (resProd.ok) {
            const products = await resProd.json();
            const prodBody = document.getElementById("topProductsBody");
            prodBody.innerHTML = "";

            if (products.length === 0) {
                 prodBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Không có sản phẩm nào được bán trong khoảng thời gian này</td></tr>`;
            } else {
                products.forEach(p => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${p.tenSP}</td>
                        <td>${p.loai}</td>
                        <td style="color: blue; font-weight: bold; text-align: center;">${p.soLuongBan}</td>
                        <td>${parseInt(p.gia).toLocaleString('vi-VN')} đ</td>
                    `;
                    prodBody.appendChild(tr);
                });
            }
        }

    } catch (err) {
        console.error("Lỗi report:", err);
    }
}

    // =========================================================================
    // 4. CÁC HÀM MODAL & XỬ LÝ
    // =========================================================================

    function showAddProductModal() {
        document.getElementById('addProductModal').classList.add('active');
    }
    function showAddStaffModal() {
        document.getElementById('addStaffModal').classList.add('active');
    }
    function showAddTableModal() {
        document.getElementById('addTableModal').classList.add('active');
    }
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }
    function showEditAttendanceModal(record) {
        document.getElementById('editAttId').value = record.maCC;
        document.getElementById('editAttGioVao').value = record.gioVao ? new Date(record.gioVao).toISOString().slice(0, 19).replace('T', ' ') : '';
        document.getElementById('editAttGioRa').value = record.gioRa ? new Date(record.gioRa).toISOString().slice(0, 19).replace('T', ' ') : '';
        document.getElementById('editAttTrangThai').value = record.trangThaiTinhToan;
        document.getElementById('editAttendanceModal').classList.add('active');
    }

    async function addProduct() {
        const name = document.getElementById('productName').value;
        const category = document.getElementById('productCategory').value;
        const price = document.getElementById('productPrice').value;
        if (!name || !category || !price) {
            showToast('Vui lòng điền đầy đủ thông tin!', 'error');
            return;
        }
        try {
            await apiCall('/products', 'POST', { tenSP: name, loai: category, gia: parseFloat(price) }); 
            closeModal('addProductModal');
            showToast('Thêm sản phẩm thành công!', 'success');
            loadProducts(); 
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
        } catch (error) { console.error("Lỗi thêm sản phẩm:", error); }
    }

    async function addStaff() {
        const name = document.getElementById('staffName').value;
        const role = document.getElementById('staffRole').value;
        const email = document.getElementById('staffEmail').value;
        if (!name || !role || !email) {
            showToast('Vui lòng điền tên, vai trò và email!', 'error');
            return;
        }
        try {
            await apiCall('/users', 'POST', { tenNV: name, vaiTro: role, taiKhoan: email, matKhau: "123456", caLamViec: "Ca sáng" }); 
            closeModal('addStaffModal');
            showToast('Thêm nhân viên thành công!', 'success');
            loadStaff(); 
            document.getElementById('staffName').value = '';
            document.getElementById('staffEmail').value = '';
        } catch (error) { console.error("Lỗi thêm nhân viên:", error); }
    }

    async function addTable() {
        const name = document.getElementById('tableName').value;
        if (!name) {
        showToast('Vui lòng điền tên bàn!', 'error');
        return;
    }
        try {
            await apiCall('/tables', 'POST', { 
            tenBan: name, 
            trangThai: "Trong" 
            // Đã xóa soGhe
        });
            showToast('Thêm bàn thành công!', 'success');
            closeModal('addTableModal');
            loadTables(); 
            document.getElementById('tableName').value = '';
        } catch (error) { console.error("Lỗi thêm bàn:", error); }
    }

    function addToOrder(product) {
        if (product) {
            const existingItem = currentOrder.find(item => item.maSP === product.maSP);
            if (existingItem) { existingItem.soLuong++; } 
            else { currentOrder.push({ maSP: product.maSP, tenSP: product.tenSP, gia: product.gia, soLuong: 1 }); }
            updateOrderSummary();
            showToast(`Đã thêm ${product.tenSP} vào đơn hàng`, 'success');
        }
    }

    function updateOrderSummary() {
        const orderItemsDiv = document.getElementById('orderItems');
        const orderTotalSpan = document.getElementById('orderTotal');
        if (currentOrder.length === 0) {
            orderItemsDiv.innerHTML = '<p>Chưa có món nào</p>';
            orderTotalSpan.textContent = '0 VNĐ';
            return;
        }
        let html = '';
        let total = 0;
        currentOrder.forEach((item, index) => {
            html += `<p>${item.tenSP} (x${item.soLuong}) - ${(item.gia * item.soLuong).toLocaleString()} VNĐ <button onclick="removeFromOrder(${index})" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 2px 8px; margin-left: 10px;">Xóa</button></p>`;
            total += (item.gia * item.soLuong);
        });
        orderItemsDiv.innerHTML = html;
        orderTotalSpan.textContent = `${total.toLocaleString()} VNĐ`;
    }

    function removeFromOrder(index) {
        currentOrder.splice(index, 1); 
        updateOrderSummary();
        showToast('Đã xóa món khỏi đơn hàng', 'warning');
    }

    async function confirmOrder() {
    const maBan = document.getElementById('orderTable').value;
    if (!maBan || currentOrder.length === 0) {
        showToast('Vui lòng chọn bàn và thêm món!', 'error');
        return;
    }
    try {
        const tongTien = currentOrder.reduce((total, item) => total + (item.gia * item.soLuong), 0);
        const maNV = CURRENT_USER_INFO.maNV; 
        const chiTietDonHang = currentOrder.map(item => ({ maSP: item.maSP, soLuong: item.soLuong, ghiChu: "" }));
        
        // 1. Tạo đơn hàng
        await apiCall('/orders', 'POST', { maNV, maBan: parseInt(maBan), tongTien, trangThai: "DangXuLy", items: chiTietDonHang });

        // --- THÊM ĐOẠN NÀY: Cập nhật trạng thái bàn thành "DangPhucVu" ---
        await apiCall(`/tables/${maBan}/status`, 'PATCH', { trangThai: 'DangPhucVu' });
        // ------------------------------------------------------------------

        showToast('Đơn hàng đã được tạo thành công!', 'success');
        currentOrder = [];
        updateOrderSummary();
        document.getElementById('orderTable').value = '';
        
        loadTablesForStaff(); // Tải lại dropdown
        loadTables();         // Tải lại sơ đồ bàn (để thấy bàn chuyển sang màu đỏ)

    } catch (error) { console.error("Lỗi xác nhận đơn hàng:", error); }
}

    // Xử lý khi bấm "Đã thanh toán"
    // Nhận thêm tham số tableId (mã bàn)
async function processPayment(orderId, tableId) {
    if (!confirm("Xác nhận khách đã thanh toán?")) return;

    try {
        // 1. Cập nhật trạng thái Đơn hàng -> DaThanhToan
        await apiCall(`/orders/${orderId}`, 'PUT', { 
            trangThai: 'DaThanhToan' 
        });

        // 2. Cập nhật trạng thái Bàn -> Trong (QUAN TRỌNG)
        if (tableId) {
            await apiCall(`/tables/${tableId}/status`, 'PATCH', { trangThai: 'Trong' });
        }

        // 3. Thông báo & Tải hóa đơn
        showToast("Thanh toán thành công!", "success");
        
        // Nếu bạn có hàm tải hóa đơn thì gọi ở đây
        if (typeof downloadInvoiceByOrderId === 'function') {
            await downloadInvoiceByOrderId(orderId);
        }

        // 4. Cập nhật lại giao diện
        loadPayments();       // Làm mới bảng thanh toán
        loadTables();         // Làm mới sơ đồ bàn (Admin)
        loadTablesForStaff(); // Làm mới dropdown chọn bàn (Nhân viên)

    } catch (error) {
        console.error("Lỗi thanh toán:", error);
        showToast("Có lỗi xảy ra khi thanh toán", "error");
    }
}

    // Xử lý khi bấm "Hủy"
    async function cancelOrder(orderId) {
        if (!confirm(`Bạn có chắc chắn muốn HỦY đơn hàng #${orderId}?`)) return;
        
        try {
            // Gọi API cập nhật trạng thái đơn hàng thành 'Huy'
            // (Route này đã có sẵn trong order.routes.js của bạn: PUT /api/orders/:id)
            await apiCall(`/orders/${orderId}`, 'PUT', { 
                trangThai: 'Huy' 
            });
            
            showToast(`Đã hủy đơn hàng #${orderId}!`, 'warning');
            loadPayments(); // Tải lại bảng (đơn hàng sẽ biến mất khỏi danh sách vì không còn là 'DangXuLy')
        } catch (error) {
            console.error("Lỗi hủy đơn:", error);
        }
    }

    async function submitLeaveRequest() {
        const leaveType = document.getElementById('leaveType').value;
        const fromDate = document.getElementById('leaveFromDate').value;
        const toDate = document.getElementById('leaveToDate').value;
        const reason = document.getElementById('leaveReason').value;
        if (!leaveType || !fromDate || !toDate || !reason) {
            showToast('Vui lòng điền đầy đủ thông tin!', 'error');
            return;
        }
        try {
            await apiCall('/leaves', 'POST', { loaiPhep: leaveType, tuNgay: fromDate, denNgay: toDate, lyDo: reason, trangThai: 'ChoDuyet' });
            showToast('Đơn nghỉ phép đã được nộp thành công!', 'success');
            document.getElementById('leaveType').value = '';
            document.getElementById('leaveFromDate').value = '';
            document.getElementById('leaveToDate').value = '';
            document.getElementById('leaveReason').value = '';
            loadMyLeaveHistory();
        } catch (error) { console.error("Lỗi nộp đơn nghỉ phép:", error); }
    }

    async function approveLeave(leaveId) {
        try {
            await apiCall(`/leaves/${leaveId}/approve`, 'PUT');
            showToast(`Đã duyệt đơn nghỉ phép #${leaveId}!`, 'success');
            loadLeaves(); 
        } catch (error) { console.error("Lỗi duyệt phép:", error); }
    }

    async function rejectLeave(leaveId) {
         try {
            await apiCall(`/leaves/${leaveId}/reject`, 'PUT');
            showToast(`Đã từ chối đơn nghỉ phép #${leaveId}!`, 'warning');
            loadLeaves(); 
        } catch (error) { console.error("Lỗi từ chối phép:", error); }
    }

    async function assignShift() {
        const maNV = document.getElementById('shiftEmployee').value;
        const ngayLamViec = document.getElementById('shiftDate').value;
        const tenCa = document.getElementById('shiftName').value;
        if (!maNV || !ngayLamViec || !tenCa) {
            showToast("Vui lòng chọn đủ thông tin để xếp ca.", "error");
            return;
        }
        let gioBatDau, gioKetThuc;
        switch (tenCa) {
            case 'Ca Sáng': gioBatDau = '07:00:00'; gioKetThuc = '12:00:00'; break;
            case 'Ca Chiều': gioBatDau = '12:00:00'; gioKetThuc = '18:00:00'; break;
            case 'Ca Tối': gioBatDau = '18:00:00'; gioKetThuc = '23:00:00'; break;
        }
        try {
            await apiCall('/shifts', 'POST', { maNV, ngayLamViec, tenCa, gioBatDau, gioKetThuc });
            showToast("Xếp ca thành công!", "success");
            loadAttendance(); 
        } catch (error) { console.error("Lỗi xếp ca:", error); }
    }

    async function handleUpdateAttendance() {
        const id = document.getElementById('editAttId').value;
        const gioVao = document.getElementById('editAttGioVao').value;
        const gioRa = document.getElementById('editAttGioRa').value;
        const trangThai = document.getElementById('editAttTrangThai').value;
        try {
            await apiCall(`/attendance/${id}`, 'PUT', { gioVao: gioVao || null, gioRa: gioRa || null, trangThai: trangThai });
            showToast("Cập nhật thành công!", "success");
            closeModal('editAttendanceModal');
            loadAttendance(); 
        } catch (error) { console.error("Lỗi cập nhật chấm công:", error); }
    }

    async function deleteAttendance(id) {
        if (!confirm("Bạn có chắc chắn muốn xóa mục chấm công này?")) return;
        try {
            await apiCall(`/attendance/${id}`, 'DELETE');
            showToast("Xóa mục chấm công thành công!", "success");
            loadAttendance(); 
        } catch (error) { console.error("Lỗi xóa chấm công:", error); }
    }

    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => { toast.remove(); }, 3000);
    }

    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.classList.remove('active');
        }
    });
    updateOrderSummary();

    // Google Login
    function loginWithGoogle() {
        google.accounts.id.initialize({
            client_id: "420409451031-jpsu99k3t2r1kqmnjluhs5uppgtghomt.apps.googleusercontent.com",
            callback: handleGoogleResponse
        });
        google.accounts.id.prompt();
    }

    async function handleGoogleResponse(response) {
        try {
            const tokenId = response.credential;
            const res = await fetch(`${API_BASE_URL}/auth/google`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ tokenId })
            });
            const data = await res.json();
            if (!res.ok) {
                showToast(data.message || "Đăng nhập Google thất bại", "error");
                return;
            }
            localStorage.setItem("token", data.token);
            localStorage.setItem("user_info", JSON.stringify(data.user));
            JWT_TOKEN = data.token;
            CURRENT_USER_INFO = data.user;
            navigateToDashboard(data.user.vaiTro);
            showToast("Đăng nhập Google thành công!", "success");
        } catch (err) {
            console.error("Google login error:", err);
            showToast("Đăng nhập Google thất bại!", "error");
        }
    }

    window.onload = function () {
        google.accounts.id.initialize({
            client_id: "420409451031-jpsu99k3t2r1kqmnjluhs5uppgtghomt.apps.googleusercontent.com",
            callback: handleGoogleResponse
        });
        google.accounts.id.renderButton(
            document.getElementById("g_id_signin"),
            { theme: "outline", size: "large", text: "signin_with" }
        );
    };



    
function showChangePasswordModal() {
  document.getElementById('changePasswordModal').style.display = 'block';
}

function closeChangePasswordModal() {
  document.getElementById('changePasswordModal').style.display = 'none';
}

async function changePassword() {
    const oldPassword = document.getElementById("oldPassword").value;
    const newPassword = document.getElementById("newPassword").value;
    const confirmPassword = document.getElementById("confirmPassword").value;

    try {
        const res = await apiCall('/users/change-password', 'PUT', {
            oldPassword,
            newPassword,
            confirmPassword
        });

        showToast("Đổi mật khẩu thành công!", "success");
        closeChangePasswordModal();
        
    } catch (err) {
        console.error("Lỗi đổi mật khẩu:", err);
        showToast(err.message, "error");
    }
}

function openEditModal(product) {
    document.getElementById("edit_maSP").value = product.maSP;
    document.getElementById("edit_tenSP").value = product.tenSP;
    document.getElementById("edit_loai").value = product.loai;
    document.getElementById("edit_gia").value = product.gia;

    document.getElementById("editProductModal").classList.add("active");
}

async function confirmEditProduct() {
    const id = document.getElementById("edit_maSP").value;

    const body = {
        tenSP: document.getElementById("edit_tenSP").value,
        loai: document.getElementById("edit_loai").value,
        gia: parseFloat(document.getElementById("edit_gia").value)
    };

    try {
        await apiCall(`/products/${id}`, 'PUT', body);
        
        closeModal('editProductModal'); 
        loadProducts(); 
        showToast("Cập nhật sản phẩm thành công!");
    } catch (err) {
        console.error("Lỗi cập nhật:", err);
        showToast("Lỗi cập nhật sản phẩm", "error");
    }
}

async function deleteProduct(id) {
    if (!confirm("Bạn có chắc muốn xoá sản phẩm này?")) return;

    try {
        await apiCall(`/products/${id}`, 'DELETE');

        showToast("Xóa thành công!");
        loadProducts(); // reload bảng

    } catch (err) {
        console.error("Lỗi xóa:", err);
        showToast("Xóa thất bại!", "error");
    }
}

// Hàm hỗ trợ: Tải hóa đơn về máy tính dựa trên ID đơn hàng
async function downloadInvoiceByOrderId(orderId) {
    try {
        // 1. Lấy chi tiết đơn hàng mới nhất từ API để in
        const order = await apiCall(`/orders/${orderId}`, 'GET');
        
        // 2. Chuẩn bị nội dung hóa đơn
        let itemsText = '';
        let totalAmount = 0;

        if (order.ChiTietDonHangs && order.ChiTietDonHangs.length > 0) {
            order.ChiTietDonHangs.forEach(item => {
                // Tính thành tiền từng món (giả sử item có gia hoặc SanPham.gia)
                const price = item.SanPham ? item.SanPham.gia : 0; 
                const amount = price * item.soLuong;
                totalAmount += amount;
                
                const tenSP = item.SanPham ? item.SanPham.tenSP : 'Món không tên';
                itemsText += `${tenSP}\tSL: ${item.soLuong}\tĐơn giá: ${price.toLocaleString()}\tThành tiền: ${amount.toLocaleString()}\r\n`;
            });
        }

        // Format ngày giờ
        const date = new Date(order.thoiGian || new Date());
        const dateStr = date.toLocaleString('vi-VN');

        const text = `
HÓA ĐƠN #${orderId}
========================
Bàn: ${order.maBan}
Ngày tạo: ${dateStr}
Trạng thái: Đã thanh toán

Danh sách món:
${itemsText}

------------------------
TỔNG TIỀN: ${totalAmount.toLocaleString()} VNĐ
========================
Cảm ơn quý khách!
`;

        // 3. Tải file .txt về (Logic Notepad)
        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `HoaDon_${orderId}.txt`; // Tên file
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

    } catch (err) {
        console.error("Lỗi khi tải hóa đơn:", err);
        alert("Thanh toán thành công nhưng lỗi khi tải file hóa đơn.");
    }
}

// --- XỬ LÝ XÓA BÀN ---
async function deleteTable(id) {
    if (!confirm("Bạn có chắc chắn muốn xóa bàn này không?")) return;

    try {
        await apiCall(`/tables/${id}`, 'DELETE');
        showToast("Đã xóa bàn thành công!", "success");
        loadTables(); // Tải lại giao diện
    } catch (error) {
        console.error("Lỗi xóa bàn:", error);
        showToast("Không thể xóa bàn (có thể đang có đơn hàng?)", "error");
    }
}

// --- XỬ LÝ SỬA BÀN ---

// 1. Mở modal và điền dữ liệu cũ
function openEditTableModal(id, currentName) {
    document.getElementById('editTableId').value = id;
    document.getElementById('editTableName').value = currentName;
    
    // Mở modal (Giả sử bạn dùng class 'modal' và css display:block khi có class active)
    document.getElementById('editTableModal').classList.add('active'); 
    // Hoặc: document.getElementById('editTableModal').style.display = 'block';
}

// 2. Gọi API cập nhật
async function handleUpdateTable() {
    const id = document.getElementById('editTableId').value;
    const newName = document.getElementById('editTableName').value;

    if (!newName) {
        showToast("Tên bàn không được để trống", "warning");
        return;
    }

    try {
        // Gọi API PUT
        await apiCall(`/tables/${id}`, 'PUT', { tenBan: newName });
        
        showToast("Cập nhật tên bàn thành công!", "success");
        closeModal('editTableModal');
        loadTables(); // Refresh lại danh sách
    } catch (error) {
        console.error("Lỗi sửa bàn:", error);
        showToast("Lỗi cập nhật tên bàn", "error");
    }
}

// Biến toàn cục lưu trạng thái: true = đang làm, false = chưa vào ca
let isShiftActive = false; 

// 1. Hàm xử lý khi bấm nút trên Menu
async function handleNavAttendanceClick() {
    if (isShiftActive) {
        // Nếu đang làm -> Bấm nút sẽ là Tan Ca
        await handleSelfCheckOut();
    } else {
        // Nếu chưa làm -> Bấm nút sẽ là Vào Ca
        await handleSelfCheckIn();
    }
}

// 2. Hàm Vào Ca (Check In)
async function handleSelfCheckIn() {
    const now = new Date();
    const hour = now.getHours();
    
    // Logic xác định ca (như cũ)
    let tenCa = "";
    if (hour >= 6 && hour < 12) tenCa = "Ca Sáng";
    else if (hour >= 12 && hour < 18) tenCa = "Ca Chiều";
    else if (hour >= 18 && hour <= 23) tenCa = "Ca Tối";
    else {
        showToast("Hiện tại không thuộc khung giờ làm việc!", "error");
        return;
    }

    const maNV = CURRENT_USER_INFO.maNV; 
    const ngayLamViec = now.toISOString().split('T')[0]; 
    const gioBatDau = now.toLocaleTimeString('vi-VN', { hour12: false });

    try {
        await apiCall('/shifts', 'POST', { 
            maNV, ngayLamViec, tenCa, gioBatDau, gioKetThuc: null 
        });

        showToast(`Đã vào ${tenCa} lúc ${gioBatDau}`, "success");
        updateNavButtonState(true); // Chuyển nút sang trạng thái "Tan Ca"
        
    } catch (error) {
        console.error(error);
        showToast(error.message || "Lỗi điểm danh", "error");
    }
}

// 3. Hàm Tan Ca (Check Out)
async function handleSelfCheckOut() {
    if(!confirm("Xác nhận kết thúc ca làm việc hiện tại?")) return;

    const now = new Date();
    const gioKetThuc = now.toLocaleTimeString('vi-VN', { hour12: false });

    try {
        // 1. Lấy danh sách ca làm việc
        const myShifts = await apiCall('/shifts/my', 'GET');
        
        // 2. Tìm ca đang mở (chưa có giờ kết thúc)
        const activeShift = myShifts.find(s => !s.gioKetThuc || s.gioKetThuc === null); 

        if (!activeShift) {
            showToast("Không tìm thấy ca đang mở!", "error");
            updateNavButtonState(false);
            return;
        }

        // 3. LẤY ID CA (Đã sửa: Thêm activeShift.maLich)
        // Dựa vào log của bạn, tên đúng là 'maLich'
        const shiftId = activeShift.maLich || activeShift.maCa || activeShift.id;

        if (!shiftId) {
            showToast("Lỗi code Frontend: Không tìm thấy ID (maLich)", "error");
            console.error("Object ca làm việc:", activeShift);
            return;
        }

        // 4. Gọi API cập nhật
        await apiCall(`/shifts/${shiftId}`, 'PUT', { gioKetThuc });

        showToast(`Đã tan ca lúc ${gioKetThuc}`, "success");
        updateNavButtonState(false); // Đổi nút về trạng thái "Vào Ca"

    } catch (error) {
        console.error("Lỗi check-out:", error);
        showToast("Lỗi khi tan ca: " + error.message, "error");
    }
}

// 4. Hàm cập nhật giao diện nút (Màu sắc & Chữ)
function updateNavButtonState(isActive) {
    isShiftActive = isActive;
    const btn = document.getElementById('navAttendanceBtn');
    if (!btn) return;

    if (isActive) {
        // Trạng thái: Đang làm việc -> Hiển thị nút đỏ (Tan ca)
        btn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Tan Ca';
        btn.style.backgroundColor = '#e74c3c'; // Màu đỏ
        btn.title = "Bấm để kết thúc ca làm việc";
    } else {
        // Trạng thái: Chưa làm -> Hiển thị nút xanh (Vào ca)
        btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Vào Ca';
        btn.style.backgroundColor = '#2ecc71'; // Màu xanh lá
        btn.title = "Bấm để bắt đầu ca làm việc";
    }
}

// 5. Kiểm tra trạng thái khi tải trang
async function checkAttendanceStatus() {
    const btn = document.getElementById('navAttendanceBtn');
    if (!btn) return; // Nếu không phải giao diện nhân viên thì thoát

    try {
        const myShifts = await apiCall('/shifts/my', 'GET');
        // Tìm ca chưa có giờ kết thúc
        const today = new Date().toISOString().split('T')[0];
        const activeShift = myShifts.find(s => !s.gioKetThuc); // Bỏ check ngày nếu muốn ca qua đêm

        if (activeShift) {
            updateNavButtonState(true);
        } else {
            updateNavButtonState(false);
        }
    } catch (e) { 
        console.log("Lỗi check trạng thái:", e);
        btn.innerText = "Lỗi";
    }
}

// Gọi ngay khi load trang
checkAttendanceStatus();


// 1. Cấu hình giờ chuẩn của các ca (Bạn có thể sửa giờ tại đây)
const SHIFT_CONFIG = {
    'Ca Sáng':  { start: 7,  end: 12 }, // 07:00 - 12:00
    'Ca Chiều': { start: 12, end: 18 }, // 12:00 - 18:00
    'Ca Tối':   { start: 18, end: 23 }  // 18:00 - 23:00
};

// 2. Hàm tải danh sách nhân viên vào dropdown lọc
async function loadEmployeeFilter() {
    try {
        const staffList = await apiCall('/users', 'GET');
        const select = document.getElementById('filterEmployee');
        // Giữ lại option đầu tiên (Tất cả)
        select.innerHTML = '<option value="all">-- Tất cả nhân viên --</option>';
        
        staffList.forEach(staff => {
            select.innerHTML += `<option value="${staff.maNV}">${staff.tenNV} (${staff.vaiTro})</option>`;
        });
    } catch (e) { console.error(e); }
}

// 3. Hàm chính: Tải và Phân tích dữ liệu chấm công
async function loadAttendanceReport() {
    const filterNvId = document.getElementById('filterEmployee').value;
    const fromDate = document.getElementById('filterFromDate').value;
    const toDate = document.getElementById('filterToDate').value;

    try {
        // Lấy toàn bộ lịch làm việc (hoặc API filter nếu backend hỗ trợ)
        // Ở đây giả sử lấy hết rồi filter client-side cho đơn giản
        const shifts = await apiCall('/shifts', 'GET'); 

        const tbody = document.getElementById('attendanceReportBody');
        tbody.innerHTML = '';

        // Lọc dữ liệu
        const filteredShifts = shifts.filter(s => {
            // Lọc theo nhân viên
            if (filterNvId !== 'all' && s.maNV != filterNvId) return false;
            
            // Lọc theo ngày (Nếu có chọn)
            if (fromDate && s.ngayLamViec < fromDate) return false;
            if (toDate && s.ngayLamViec > toDate) return false;
            
            return true;
        });

        if (filteredShifts.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Không tìm thấy dữ liệu phù hợp</td></tr>`;
            return;
        }

        // Duyệt và hiển thị
        for (const shift of filteredShifts) {
            // Lấy tên nhân viên (Giả sử API shifts trả về object NhanVien kèm theo, hoặc bạn cần map lại)
            // Nếu API shifts chưa join bảng NhanVien, bạn có thể cần gọi thêm hoặc sửa Backend.
            // Tạm thời giả định API trả về s.NhanVien.tenNV hoặc bạn dùng s.maNV
            const staffName = shift.NhanVien ? shift.NhanVien.tenNV : `NV #${shift.maNV}`;
            
            // Phân tích giờ làm
            const analysis = analyzeAttendance(shift);

            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${new Date(shift.ngayLamViec).toLocaleDateString('vi-VN')}</td>
                <td style="font-weight:bold;">${staffName}</td>
                <td><span class="badge-shift">${shift.tenCa}</span></td>
                <td>${formatTime(shift.gioBatDau)}</td>
                <td>${formatTime(shift.gioKetThuc)}</td>
                <td>${analysis}</td>
            `;
        }

    } catch (error) {
        console.error("Lỗi tải báo cáo:", error);
    }
}

// 4. Hàm Logic: So sánh giờ để tìm lỗi đi muộn/về sớm
function analyzeAttendance(shift) {
    // Nếu chưa có giờ vào (Lỗi dữ liệu)
    if (!shift.gioBatDau) return '<span style="color:gray;">Chưa Check-in</span>';

    const config = SHIFT_CONFIG[shift.tenCa];
    if (!config) return '<span style="color:blue;">Ca tùy chỉnh</span>'; // Không thuộc ca chuẩn

    let statusHtml = '';
    let isPerfect = true;

    // --- CHECK ĐI MUỘN ---
    // Lấy giờ phút vào thực tế
    const inTime = new Date(shift.gioBatDau); 
    // Lưu ý: Backend trả về string UTC hay Local? Cần xử lý cẩn thận.
    // Giả sử inTime lấy ra đúng giờ Local.
    
    const inHour = inTime.getHours();
    const inMinute = inTime.getMinutes();

    // Quy đổi ra phút trong ngày để so sánh (VD: 7h30 = 7*60 + 30 = 450)
    const actualInMinutes = inHour * 60 + inMinute;
    const standardInMinutes = config.start * 60;
    const lateThreshold = 15; // Cho phép trễ 15 phút

    if (actualInMinutes > standardInMinutes + lateThreshold) {
        const lateMins = actualInMinutes - standardInMinutes;
        statusHtml += `<div style="color: red; font-size: 13px;">⚠️ Đi muộn ${lateMins}p</div>`;
        isPerfect = false;
    }

    // --- CHECK VỀ SỚM ---
    if (shift.gioKetThuc) {
        const outTime = new Date(shift.gioKetThuc);
        const outHour = outTime.getHours();
        const outMinute = outTime.getMinutes();
        
        const actualOutMinutes = outHour * 60 + outMinute;
        const standardOutMinutes = config.end * 60;
        const earlyThreshold = 15; // Cho phép về sớm 15p

        if (actualOutMinutes < standardOutMinutes - earlyThreshold) {
             const earlyMins = standardOutMinutes - actualOutMinutes;
             statusHtml += `<div style="color: orange; font-size: 13px;">⚠️ Về sớm ${earlyMins}p</div>`;
             isPerfect = false;
        }
    } else {
        // Chưa check-out
        statusHtml += `<div style="color: gray; font-style: italic;">Đang làm việc...</div>`;
        isPerfect = false;
    }

    if (isPerfect && shift.gioKetThuc) {
        return `<span class="status-badge status-active">✅ Đúng giờ</span>`;
    }

    return statusHtml;
}

// Hàm phụ: Format giờ đẹp (HH:mm)
function formatTime(dateString) {
    if (!dateString) return '--:--';
    const date = new Date(dateString);
    return date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit', hour12: false });
}

// Gọi khi trang tải xong
loadEmployeeFilter();
loadAttendanceReport();



</script>
<div id="editProductModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Cập nhật sản phẩm</h3>
            <button class="close-btn" onclick="closeModal('editProductModal')">&times;</button>
        </div>
        
        <input type="hidden" id="edit_maSP">

        <div class="form-row">
            <div style="flex: 1; margin-right: 10px;">
                <label for="edit_tenSP" style="font-weight: bold; display: block; margin-bottom: 5px;">Tên sản phẩm</label>
                <input type="text" class="form-control" id="edit_tenSP" style="width: 100%;">
            </div>

            <div style="flex: 1;">
                <label for="edit_loai" style="font-weight: bold; display: block; margin-bottom: 5px;">Loại</label>
                <select class="form-control" id="edit_loai" style="width: 100%;">
                    <option value="DoUong">Đồ uống</option>
                    <option value="ThucAn">Thức ăn</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div style="flex: 1;">
                <label for="edit_gia" style="font-weight: bold; display: block; margin-bottom: 5px;">Giá bán (VNĐ)</label>
                <input type="number" class="form-control" id="edit_gia" style="width: 100%;">
            </div>
        </div>

        <button class="btn btn-primary" onclick="confirmEditProduct()" style="margin-top: 15px;">Lưu thay đổi</button>
    </div>
</div>

<div id="editTableModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Đổi tên bàn</h3>
            <button class="close-btn" onclick="closeModal('editTableModal')">&times;</button>
        </div>
        
        <input type="hidden" id="editTableId">
        
        <div class="form-row">
            <label style="font-weight: bold;">Tên bàn mới:</label>
            <input type="text" class="form-control" id="editTableName" style="width: 100%;">
        </div>
        
        <button class="btn btn-primary" onclick="handleUpdateTable()" style="margin-top: 15px;">Lưu thay đổi</button>
    </div>
</div>
</body>
</html>