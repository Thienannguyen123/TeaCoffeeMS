<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>teacoffeMS - H·ªá th·ªëng qu·∫£n l√Ω c√† ph√™</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #8B4513;
            --primary-light: #A0522D;
            --secondary: #D2691E;
            --accent: #F4A460;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f9fafb;
            --white: #ffffff;
            --border: #e5e7eb;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-lg: rgba(0, 0, 0, 0.15);
            --radius: 12px;
            --radius-lg: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
            line-height: 1.6;
        }

        /* ==================== LOGIN SECTION ==================== */
        .login-container {
            display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
            position: relative; overflow: hidden;
        }
        .login-container::before {
            content: ''; position: absolute; width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%; top: -250px; right: -250px; animation: float 6s ease-in-out infinite;
        }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(20px); } }

        .login-card {
            background: var(--white); backdrop-filter: blur(20px); border-radius: var(--radius-lg);
            padding: 48px; box-shadow: 0 20px 60px var(--shadow-lg); width: 100%; max-width: 440px;
            animation: slideUp 0.6s ease-out; position: relative; z-index: 1;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        .login-header { text-align: center; margin-bottom: 40px; }
        .logo {
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 12px;
    font-size: 2.5rem; 
    font-weight: 800;
    background: linear-gradient(135deg, var(--primary), var(--secondary));

    /* Th√™m b·∫£n chu·∫©n */
    background-clip: text;

    /* Safari, Chrome, EDGE c≈© c·∫ßn webkit */
    -webkit-background-clip: text;

    /* ƒê·ªÉ ch·ªØ trong su·ªët */
    color: transparent;
    -webkit-text-fill-color: transparent;

    margin-bottom: 12px;
}

.logo i {
    -webkit-text-fill-color: var(--secondary);
    font-size: 2rem;
}

        
        .form-group { margin-bottom: 24px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--dark); font-size: 0.9rem; }
        .input-wrapper { position: relative; }
        .input-wrapper i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 1.1rem; }
        .form-group input {
            width: 100%; padding: 14px 16px 14px 48px; border: 2px solid var(--border);
            border-radius: var(--radius); font-size: 15px; transition: var(--transition); background: var(--light);
        }
        .form-group input:focus { outline: none; border-color: var(--secondary); background: var(--white); }
        
        .login-btn {
            width: 100%; padding: 14px; background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; border: none; border-radius: var(--radius); font-size: 16px; font-weight: 600;
            cursor: pointer; transition: var(--transition); margin-top: 8px;
        }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(139, 69, 19, 0.4); }

        /* ==================== DASHBOARD ==================== */
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        .container { max-width: 1400px; margin: 0 auto; padding: 24px; }

        .header {
            background: var(--white); border-radius: var(--radius-lg); padding: 24px 32px;
            margin-bottom: 24px; box-shadow: 0 4px 12px var(--shadow);
            display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--primary);
        }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-icon {
            width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;
        }
        .header h1 { font-size: 1.75rem; font-weight: 700; color: var(--dark); margin-bottom: 4px; }
        .user-info { display: flex; align-items: center; gap: 16px; }
        .user-badge {
            padding: 10px 20px; border-radius: 24px; font-weight: 600; color: white; font-size: 0.9rem;
            display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 8px var(--shadow);
        }
        .admin .user-badge { background: linear-gradient(135deg, var(--warning), #d97706); }
        .staff .user-badge { background: linear-gradient(135deg, var(--info), #1d4ed8); }
        
        .logout-btn {
            padding: 10px 20px; background: var(--danger); color: white; border: none; border-radius: var(--radius);
            cursor: pointer; transition: var(--transition); font-weight: 600; display: flex; align-items: center; gap: 8px;
        }
        .logout-btn:hover { background: #dc2626; transform: translateY(-2px); }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex; background: var(--white); border-radius: var(--radius-lg); padding: 8px;
            margin-bottom: 24px; box-shadow: 0 2px 8px var(--shadow); overflow-x: auto; gap: 4px;
        }
        .nav-tab {
            padding: 12px 20px; border: none; background: transparent; border-radius: var(--radius);
            cursor: pointer; transition: var(--transition); white-space: nowrap; font-weight: 500; color: #6b7280;
            display: flex; align-items: center; gap: 8px;
        }
        .nav-tab.active { color: white; font-weight: 600; box-shadow: 0 4px 12px var(--shadow); }
        .admin .nav-tab.active { background: linear-gradient(135deg, var(--warning), #d97706); }
        .staff .nav-tab.active { background: linear-gradient(135deg, var(--info), #1d4ed8); }

        /* Cards & Content */
        .content-area { display: none; }
        .content-area.active { display: block; animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--white); border-radius: var(--radius-lg); padding: 28px;
            box-shadow: 0 2px 12px var(--shadow); margin-bottom: 24px; border: 1px solid var(--border);
        }
        .card h3 { margin-bottom: 20px; color: var(--dark); display: flex; align-items: center; gap: 12px; font-size: 1.3rem; }

        /* Tables */
        .table-container { background: var(--white); border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border); margin-top: 20px;}
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--light); padding: 16px; text-align: left; font-weight: 600; color: var(--dark); border-bottom: 2px solid var(--border); }
        td { padding: 16px; border-bottom: 1px solid var(--border); }
        tr:hover { background: var(--light); }

        /* Buttons & Badges */
        .btn {
            padding: 10px 20px; border: none; border-radius: var(--radius); cursor: pointer;
            font-weight: 600; transition: var(--transition); display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-primary { background: linear-gradient(135deg, var(--info), #1d4ed8); color: white; }
        .btn-success { background: linear-gradient(135deg, var(--success), #059669); color: white; }
        .btn-warning { background: linear-gradient(135deg, var(--warning), #d97706); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #dc2626); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

        .status-badge { padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; display: inline-block; }
        .status-active { background: #dcfce7; color: #166534; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-rejected { background: #fee2e2; color: #991b1b; }
        .badge-shift { background: #e0f2fe; color: #0369a1; padding: 4px 10px; border-radius: 6px; font-weight: 600; font-size: 0.8rem; }
        
        .role-admin { background: linear-gradient(135deg, var(--success), #059669); color: white; padding: 6px 14px; border-radius: 16px; font-size: 0.8rem; }
        .role-staff { background: linear-gradient(135deg, var(--info), #1d4ed8); color: white; padding: 6px 14px; border-radius: 16px; font-size: 0.8rem; }

        /* Grids */
        .menu-grid, .table-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-top: 20px; }
        .menu-item {
            border: 2px solid var(--border); border-radius: var(--radius); padding: 20px; cursor: pointer;
            text-align: center; background: var(--white); transition: var(--transition);
        }
        .menu-item:hover { border-color: var(--primary); transform: translateY(-4px); box-shadow: 0 4px 12px var(--shadow); }
        .menu-item strong { display: block; margin-bottom: 8px; color: var(--dark); }
        .menu-item p { color: var(--primary); font-weight: 700; }

        .table-item { padding: 20px; border-radius: var(--radius); text-align: center; transition: var(--transition); }
        .table-item:hover { transform: translateY(-4px); box-shadow: 0 8px 20px var(--shadow-lg); }
        
        /* Modals */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 1000; backdrop-filter: blur(8px); align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white; border-radius: var(--radius-lg); padding: 32px;
            max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto;
            box-shadow: 0 24px 48px var(--shadow-lg); animation: modalSlideIn 0.3s ease-out;
        }
        @keyframes modalSlideIn { from { opacity: 0; transform: scale(0.95) translateY(-20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; border-bottom: 2px solid var(--border); padding-bottom: 16px; }
        .close-btn { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: #9ca3af; }
        .close-btn:hover { color: var(--danger); }

        /* Form Controls */
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 16px; }
        .form-control {
            width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: var(--radius);
            transition: var(--transition); font-family: inherit; font-size: 0.95rem;
        }
        .form-control:focus { outline: none; border-color: var(--primary); }

        /* Toast */
        .toast {
            position: fixed; top: 24px; right: 24px; background: var(--success); color: white;
            padding: 16px 24px; border-radius: var(--radius); box-shadow: 0 8px 24px var(--shadow-lg);
            z-index: 1001; display: flex; align-items: center; gap: 12px; animation: toastSlideIn 0.3s ease-out;
        }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        @keyframes toastSlideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }

        /* Order Summary */
        #orderSummary { margin-top: 24px; padding: 24px; background: var(--light); border-radius: var(--radius); border: 2px solid var(--border); }
        #orderItems p {
            display: flex; justify-content: space-between; align-items: center; padding: 12px;
            background: var(--white); border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border);
        }
        
        /* Filter Controls */
        .filter-controls {
            display: flex; gap: 12px; align-items: center; margin: 20px 0; background: var(--light);
            padding: 20px; border-radius: var(--radius); flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div id="addTableModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Th√™m b√†n m·ªõi</h3>
                <button class="close-btn" onclick="closeModal('addTableModal')">&times;</button>
            </div>
            <div class="form-row">
                <label style="width: 100%;">T√™n b√†n:</label>
                <input type="text" class="form-control" id="tableName" placeholder="V√≠ d·ª•: B√†n 10">
            </div>
            <button class="btn btn-success" onclick="addTable()" style="width: 100%; margin-top: 16px;">Th√™m b√†n</button>
        </div>
    </div>

    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-key"></i> ƒê·ªïi m·∫≠t kh·∫©u</h3>
                <button class="close-btn" onclick="closeChangePasswordModal()">&times;</button>
            </div>
            <form id="changePasswordForm" onsubmit="event.preventDefault(); changePassword();">
                <div class="form-group">
                    <label for="oldPassword">M·∫≠t kh·∫©u c≈©</label>
                    <input type="password" id="oldPassword" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="newPassword">M·∫≠t kh·∫©u m·ªõi</label>
                    <input type="password" id="newPassword" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi</label>
                    <input type="password" id="confirmPassword" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 16px;">X√°c nh·∫≠n ƒë·ªïi</button>
            </form>
        </div>
    </div>

    




    <div id="loginSection" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1 class="logo"><i class="fas fa-coffee"></i> <span>teacoffeMS</span></h1>
                <p style="color: #6b7280;">H·ªá th·ªëng qu·∫£n l√Ω qu√°n c√† ph√™ chuy√™n nghi·ªáp</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">T√™n ƒëƒÉng nh·∫≠p</label>
                    <div class="input-wrapper">
                        <i class="fas fa-user"></i>
                        <input type="text" id="username" name="username" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="password">M·∫≠t kh·∫©u</label>
                    <div class="input-wrapper">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="password" name="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required>
                    </div>
                </div>
                <button type="submit" class="login-btn"><i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p</button>
                <div style="margin: 24px 0; border-bottom: 1px solid var(--border); position: relative; text-align: center;">
                    <span style="background: white; padding: 0 10px; color: #9ca3af; font-size: 0.85rem; position: relative; top: 10px;">HO·∫∂C</span>
                </div>
                <div id="g_id_signin"></div>
            </form>
        </div>
    </div>

    <div id="adminDashboard" class="dashboard admin">
        <div class="container">
            <div class="header">
                <div class="header-left">
                    <div class="header-icon"><i class="fas fa-chart-line"></i></div>
                    <div>
                        <h1>Dashboard Qu·∫£n l√Ω</h1>
                        <span style="color: #6b7280;">Xin ch√†o, qu·∫£n l√Ω!</span>
                    </div>
                </div>
                <div class="user-info">
                    <span class="user-badge"><i class="fas fa-crown"></i> Qu·∫£n l√Ω</span>
                    <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</button>
                </div>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showAdminContent('products', this)"><i class="fas fa-coffee"></i> S·∫£n ph·∫©m</button>
                <button class="nav-tab" onclick="showAdminContent('staff', this)"><i class="fas fa-users"></i> Nh√¢n vi√™n</button>
                <button class="nav-tab" onclick="showAdminContent('orders', this)"><i class="fas fa-receipt"></i> ƒê∆°n h√†ng</button>
                <button class="nav-tab" onclick="showAdminContent('revenue', this)"><i class="fas fa-chart-bar"></i> Doanh thu</button>
                <button class="nav-tab" onclick="showAdminContent('attendance', this)"><i class="fas fa-clock"></i> ƒêi·ªÉm danh</button>
                <button class="nav-tab" onclick="showAdminContent('tables', this)"><i class="fas fa-table"></i> Qu·∫£n l√Ω b√†n</button>
            </div>

            <div id="admin-products" class="content-area active">
                <div class="card">
                    <h3><i class="fas fa-coffee"></i> Qu·∫£n l√Ω s·∫£n ph·∫©m</h3>
                    <button class="btn btn-primary" onclick="showAddProductModal()"><i class="fas fa-plus"></i> Th√™m s·∫£n ph·∫©m</button>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>T√™n s·∫£n ph·∫©m</th>
                                    <th>Lo·∫°i</th>
                                    <th>Gi√°</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="admin-staff" class="content-area">
                <div class="card">
                    <h3><i class="fas fa-users"></i> Qu·∫£n l√Ω nh√¢n vi√™n</h3>
                    <button class="btn btn-primary" onclick="showAddStaffModal()"><i class="fas fa-user-plus"></i> Th√™m nh√¢n vi√™n</button>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>H·ªç t√™n</th>
                                    <th>Ch·ª©c v·ª•</th>
                                    <th>T√†i kho·∫£n</th>
                                    <th>Ca l√†m vi·ªác</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="staffTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="admin-orders" class="content-area">
                <div class="card">
                    <h3><i class="fas fa-receipt"></i> Qu·∫£n l√Ω ƒë∆°n h√†ng</h3>
                    <div style="display: flex; gap: 12px; margin: 20px 0;">
                        <input type="text" id="orderSearchInput" class="form-control" placeholder="üîç Nh·∫≠p m√£ ƒë∆°n h√†ng..." style="width: 300px;">
                        <button class="btn btn-primary" onclick="searchOrder()">T√¨m ki·∫øm</button>
                        <button class="btn btn-secondary" onclick="resetOrderSearch()">L√†m m·ªõi</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>M√£ ƒë∆°n</th>
                                    <th>B√†n s·ªë</th>
                                    <th>T·ªïng ti·ªÅn</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="admin-revenue" class="content-area">
                <div class="card">
                    <h3><i class="fas fa-chart-line"></i> B√°o c√°o doanh thu</h3>
                    <div class="filter-controls">
                        <label>T·ª´:</label>
                        <input type="date" id="revFrom" class="form-control" style="width: auto;">
                        <label>ƒê·∫øn:</label>
                        <input type="date" id="revTo" class="form-control" style="width: auto;">
                        <button class="btn btn-secondary" onclick="filterRevenue('today')">H√¥m nay</button>
                        <button class="btn btn-secondary" onclick="filterRevenue('week')">Tu·∫ßn n√†y</button>
                        <button class="btn btn-secondary" onclick="filterRevenue('month')">Th√°ng n√†y</button>
                    </div>
                    <div style="margin: 20px 0; padding: 20px; background: var(--light); border-radius: var(--radius); border-left: 4px solid var(--success);">
                        <span style="color: #6b7280; font-weight: 600;">T·ªïng doanh thu:</span>
                        <span id="totalRevenueSum" style="color: var(--success); font-size: 1.8rem; font-weight: 700; margin-left: 12px;">0 VNƒê</span>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Ng√†y</th><th>Doanh thu (VNƒê)</th></tr></thead>
                            <tbody id="revenueTableBody"></tbody>
                        </table>
                    </div>
                    <hr style="margin: 32px 0; border: 0; border-top: 1px solid var(--border);">
                    <h3><i class="fas fa-fire"></i> Top s·∫£n ph·∫©m b√°n ch·∫°y</h3>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>T√™n m√≥n</th><th>Lo·∫°i</th><th>S·ªë l∆∞·ª£ng b√°n</th><th>ƒê∆°n gi√° hi·ªán t·∫°i</th></tr></thead>
                            <tbody id="topProductsBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="admin-attendance" class="content-area">
                <div class="card">
                    <h3><i class="fas fa-user-clock"></i> Theo d√µi ch·∫•m c√¥ng</h3>
                    <div class="filter-controls">
                        <select id="filterEmployee" class="form-control" onchange="loadAttendanceReport()">
                            <option value="all">-- T·∫•t c·∫£ nh√¢n vi√™n --</option>
                        </select>
                        <input type="date" id="filterFromDate" class="form-control" onchange="loadAttendanceReport()">
                        <input type="date" id="filterToDate" class="form-control" onchange="loadAttendanceReport()">
                        <button class="btn btn-primary" onclick="loadAttendanceReport()"><i class="fas fa-search"></i> Xem</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ng√†y</th><th>Nh√¢n vi√™n</th><th>Ca l√†m</th><th>Gi·ªù v√†o</th><th>Gi·ªù ra</th><th>ƒê√°nh gi√°</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceReportBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="admin-tables" class="content-area">
                <div class="card">
                    <h3><i class="fas fa-table"></i> Qu·∫£n l√Ω b√†n</h3>
                    <button class="btn btn-primary" onclick="showAddTableModal()"><i class="fas fa-plus"></i> Th√™m b√†n</button>
                    <div id="adminTableGrid" class="table-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="staffDashboard" class="dashboard staff">
        <div class="container">
            <div class="header">
                <div class="header-left">
                    <div class="header-icon"><i class="fas fa-user-tie"></i></div>
                    <div>
                        <h1>Dashboard Nh√¢n vi√™n</h1>
                        <span style="color: #6b7280;">Ch√†o m·ª´ng tr·ªü l·∫°i!</span>
                    </div>
                </div>
                <div class="user-info">
                    <span class="user-badge"><i class="fas fa-user"></i> Nh√¢n vi√™n</span>
                    <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</button>
                </div>
            </div>

            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showStaffContent('orders', this)"><i class="fas fa-shopping-cart"></i> T·∫°o order</button>
                <button class="nav-tab" onclick="showStaffContent('payment', this)"><i class="fas fa-credit-card"></i> Thanh to√°n</button>
                <button class="nav-tab" onclick="showStaffContent('menu', this)"><i class="fas fa-book"></i> Th·ª±c ƒë∆°n</button>
                <button class="nav-tab" onclick="showStaffContent('shifts', this)"><i class="fas fa-calendar-alt"></i> Ca l√†m vi·ªác</button>
                <button class="nav-tab" onclick="showChangePasswordModal()"><i class="fas fa-key"></i> ƒê·ªïi m·∫≠t kh·∫©u</button>
                <button id="navAttendanceBtn" class="nav-tab" onclick="handleNavAttendanceClick()" style="margin-left: auto; background: #2ecc71; color: white; font-weight: 700;">
                    <i class="fas fa-clock"></i> ƒêang t·∫£i...
                </button>
            </div>

            <div id="staff-orders" class="content-area active">
                <div class="card">
                    <h3><i class="fas fa-shopping-cart"></i> T·∫°o ƒë∆°n h√†ng</h3>
                    <div class="form-row">
                        <select class="form-control" id="orderTable"><option value="">Ch·ªçn b√†n</option></select>
                    </div>
                    <h4 style="margin: 24px 0 16px 0; color: var(--dark);"><i class="fas fa-utensils"></i> Ch·ªçn m√≥n:</h4>
                    <div id="staffMenuGrid" class="menu-grid"></div>
                    <div id="orderSummary">
                        <h4>üìù ƒê∆°n h√†ng hi·ªán t·∫°i:</h4>
                        <div id="orderItems"></div>
                        <p style="margin-top: 16px; padding-top: 16px; border-top: 2px solid var(--border); display: flex; justify-content: space-between;">
                            <strong style="font-size: 1.1rem;">T·ªïng ti·ªÅn:</strong>
                            <span id="orderTotal" style="font-size: 1.3rem; color: var(--primary); font-weight: 700;">0 VNƒê</span>
                        </p>
                        <button class="btn btn-success" onclick="confirmOrder()" style="width: 100%; margin-top: 16px; padding: 14px;">
                            <i class="fas fa-check-circle"></i> X√°c nh·∫≠n ƒë∆°n h√†ng
                        </button>
                    </div>
                </div>
            </div>

            <div id="staff-payment" class="content-area">
                <div class="card">
                    <h3><i class="fas fa-credit-card"></i> Thanh to√°n</h3>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>B√†n</th><th>Kh√°ch h√†ng</th><th>M√≥n</th><th>T·ªïng ti·ªÅn</th><th>Thao t√°c</th></tr></thead>
                            <tbody id="paymentTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="staff-menu" class="content-area">
                <div class="card">
                    <h3><i class="fas fa-book-open"></i> Th·ª±c ƒë∆°n</h3>
                    <div id="staffFullMenuGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-top: 24px;"></div>
                </div>
            </div>

            <div id="staff-shifts" class="content-area">
                <div class="card">
                    <h3><i class="fas fa-calendar-check"></i> Ca l√†m vi·ªác c·ªßa t√¥i</h3>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Ng√†y</th><th>Ca</th><th>Gi·ªù v√†o</th><th>Gi·ªù ra</th><th>T·ªïng gi·ªù</th><th>Tr·∫°ng th√°i</th></tr></thead>
                            <tbody id="staffShiftsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Th√™m s·∫£n ph·∫©m m·ªõi</h3>
                <button class="close-btn" onclick="closeModal('addProductModal')">&times;</button>
            </div>
            <div class="form-row">
                <div style="flex: 1;">
                    <label for="productName">T√™n s·∫£n ph·∫©m</label>
                    <input type="text" class="form-control" id="productName" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m">
                </div>
                <div style="flex: 1;">
                    <label for="productCategory">Lo·∫°i</label>
                    <select class="form-control" id="productCategory">
                        <option value="">-- Ch·ªçn lo·∫°i --</option>
                        <option value="DoUong">ƒê·ªì u·ªëng</option>
                        <option value="ThucAn">Th·ª©c ƒÉn</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div style="flex: 1;">
                    <label for="productPrice">Gi√° b√°n (VNƒê)</label>
                    <input type="number" class="form-control" id="productPrice" placeholder="Nh·∫≠p gi√°">
                </div>
            </div>
            <button class="btn btn-success" onclick="addProduct()" style="width: 100%; margin-top: 16px;">Th√™m s·∫£n ph·∫©m</button>
        </div>
    </div>

    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>C·∫≠p nh·∫≠t s·∫£n ph·∫©m</h3>
                <button class="close-btn" onclick="closeModal('editProductModal')">&times;</button>
            </div>
            <input type="hidden" id="edit_maSP">
            <div class="form-row">
                <div style="flex: 1;">
                    <label for="edit_tenSP">T√™n s·∫£n ph·∫©m</label>
                    <input type="text" class="form-control" id="edit_tenSP">
                </div>
                <div style="flex: 1;">
                    <label for="edit_loai">Lo·∫°i</label>
                    <select class="form-control" id="edit_loai">
                        <option value="DoUong">ƒê·ªì u·ªëng</option>
                        <option value="ThucAn">Th·ª©c ƒÉn</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div style="flex: 1;">
                    <label for="edit_gia">Gi√° b√°n (VNƒê)</label>
                    <input type="number" class="form-control" id="edit_gia">
                </div>
            </div>
            <button class="btn btn-primary" onclick="confirmEditProduct()" style="width: 100%; margin-top: 16px;">L∆∞u thay ƒë·ªïi</button>
        </div>
    </div>

    <div id="addStaffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Th√™m nh√¢n vi√™n m·ªõi</h3>
                <button class="close-btn" onclick="closeModal('addStaffModal')">&times;</button>
            </div>
            <div class="form-row">
                <div style="flex: 1;">
                    <label for="staffName">H·ªç v√† t√™n</label>
                    <input type="text" class="form-control" id="staffName" placeholder="Nh·∫≠p h·ªç t√™n">
                </div>
                <div style="flex: 1;">
                    <label for="staffRole">Ch·ª©c v·ª•</label>
                    <select class="form-control" id="staffRole">
                        <option value="NhanVien">Nh√¢n vi√™n</option>
                        <option value="QuanLy">Qu·∫£n l√Ω</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div style="flex: 1;">
                    <label for="staffEmail">Email/T√†i kho·∫£n</label>
                    <input type="email" class="form-control" id="staffEmail" placeholder="Nh·∫≠p email">
                </div>
            </div>
            <div style="margin-top: 12px; text-align: center; font-size: 0.9em; color: #666;">
            <i class="fas fa-info-circle"></i> M·∫≠t kh·∫©u m·∫∑c ƒë·ªãnh s·∫Ω l√† <strong>123456</strong>
        </div>
            <button class="btn btn-success" onclick="addStaff()" style="width: 100%; margin-top: 16px;">Th√™m nh√¢n vi√™n</button>
        </div>
    </div>

    <div id="editStaffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>S·ª≠a th√¥ng tin nh√¢n vi√™n</h3>
                <button class="close-btn" onclick="closeModal('editStaffModal')">&times;</button>
            </div>
            <input type="hidden" id="editStaffId">
            <div class="form-row">
                <div style="flex: 1;">
                    <label for="editStaffName">H·ªç v√† t√™n</label>
                    <input type="text" class="form-control" id="editStaffName">
                </div>
                <div style="flex: 1;">
                    <label for="editStaffRole">Vai tr√≤</label>
                    <select class="form-control" id="editStaffRole">
                        <option value="NhanVien">Nh√¢n vi√™n</option>
                        <option value="QuanLy">Qu·∫£n l√Ω</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div style="flex: 1;">
                    <label for="editStaffEmail">Email/T√†i kho·∫£n</label>
                    <input type="email" class="form-control" id="editStaffEmail">
                </div>
                <div style="flex: 1;">
                    <label for="editStaffShift">Ca l√†m vi·ªác</label>
                    <select class="form-control" id="editStaffShift">
                        <option value="Ca s√°ng">Ca s√°ng</option>
                        <option value="Ca chi·ªÅu">Ca chi·ªÅu</option>
                        <option value="Ca t·ªëi">Ca t·ªëi</option>
                    </select>
                </div>
                <div class="form-group" id="editStaffPasswordGroup" style="display: none;">
    <label>M·∫≠t kh·∫©u m·ªõi (ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën ƒë·ªïi)</label>
    <input type="password" id="editStaffPassword" class="form-control" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi...">
</div>
            </div>
            <button class="btn btn-success" onclick="handleUpdateStaff()" style="width: 100%; margin-top: 16px;">C·∫≠p nh·∫≠t</button>
        </div>
    </div>

    <div id="orderDetailModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Chi ti·∫øt h√≥a ƒë∆°n #<span id="detailOrderId"></span></h3>
                <button class="close-btn" onclick="closeModal('orderDetailModal')">&times;</button>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; font-size: 0.9rem;">
                <div>
                    <p><strong>B√†n:</strong> <span id="detailTableName"></span></p>
                    <p><strong>Nh√¢n vi√™n:</strong> <span id="detailStaffName"></span></p>
                </div>
                <div style="text-align: right;">
                    <p><strong>Ng√†y t·∫°o:</strong> <span id="detailCreatedTime"></span></p>
                    <p><strong>Thanh to√°n:</strong> <span id="detailPaymentTime"></span></p>
                </div>
            </div>
            <div class="table-container" style="margin-bottom: 20px; box-shadow: none; border: 1px solid #eee;">
                <table>
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th>T√™n m√≥n</th><th style="text-align: center;">SL</th><th style="text-align: right;">ƒê∆°n gi√°</th><th style="text-align: right;">Th√†nh ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody id="detailItemsBody"></tbody>
                </table>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 2px solid #eee;">
                <div><strong>Tr·∫°ng th√°i:</strong> <span id="detailStatusBadge"></span></div>
                <div style="font-size: 1.2rem;"><strong>T·ªïng ti·ªÅn:</strong> <span id="detailTotalAmount" style="color: var(--primary);"></span></div>
            </div>
            <button onclick="printOrder()" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
    <i class="fas fa-file-download"></i> T·∫£i h√≥a ƒë∆°n (TXT)
</button>
    </div>

    
    <div id="editTableModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ƒê·ªïi t√™n b√†n</h3>
                <button class="close-btn" onclick="closeModal('editTableModal')">&times;</button>
            </div>
            <input type="hidden" id="editTableId">
            <div class="form-row">
                <label style="width: 100%;">T√™n b√†n m·ªõi:</label>
                <input type="text" class="form-control" id="editTableName">
            </div>
            <button class="btn btn-primary" onclick="handleUpdateTable()" style="width: 100%; margin-top: 16px;">L∆∞u thay ƒë·ªïi</button>
        </div>
    </div>

    <div id="editAttendanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>S·ª≠a ch·∫•m c√¥ng</h3>
                <button class="close-btn" onclick="closeModal('editAttendanceModal')">&times;</button>
            </div>
            <input type="hidden" id="editAttId">
            <div class="form-row">
                <label style="width: 100%;">Gi·ªù v√†o (YYYY-MM-DD HH:MM:SS):</label>
                <input type="text" class="form-control" id="editAttGioVao">
            </div>
            <div class="form-row">
                 <label style="width: 100%;">Gi·ªù ra (YYYY-MM-DD HH:MM:SS):</label>
                <input type="text" class="form-control" id="editAttGioRa">
            </div>
             <div class="form-row">
                 <label style="width: 100%;">Tr·∫°ng th√°i:</label>
                <select id="editAttTrangThai" class="form-control">
                    <option value="ƒê√∫ng gi·ªù">ƒê√∫ng gi·ªù</option>
                    <option value="ƒêi tr·ªÖ">ƒêi tr·ªÖ</option>
                    <option value="Ngo√†i gi·ªù">Ngo√†i gi·ªù</option>
                    <option value="Ch∆∞a check-in">Ch∆∞a check-in</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="handleUpdateAttendance()" style="width: 100%; margin-top: 16px;">C·∫≠p nh·∫≠t</button>
        </div>
    </div>

    <script>
    // ==================== GLOBAL VARIABLES ====================
    let currentOrder = [];
    let allOrdersList = [];
    
    const API_BASE_URL = 'http://localhost:5000/api';
    let JWT_TOKEN = localStorage.getItem('token') || null;
    let CURRENT_USER_INFO = JSON.parse(localStorage.getItem('user_info')) || null;
    const REPORT_API = `${API_BASE_URL}/reports`;
    const SHIFT_CONFIG = { 'Ca S√°ng': { start: 7, end: 12 }, 'Ca Chi·ªÅu': { start: 12, end: 18 }, 'Ca T·ªëi': { start: 18, end: 23 } };

    // ==================== LOGIN & AUTH ====================
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const taiKhoan = document.getElementById('username').value;
        const matKhau = document.getElementById('password').value;

        fetch(`${API_BASE_URL}/auth/login`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ taiKhoan, matKhau })
        })
        .then(response => {
            if (!response.ok) return response.json().then(error => { throw new Error(error.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i'); });
            return response.json();
        })
        .then(data => {
            localStorage.setItem('token', data.token);
            localStorage.setItem('user_info', JSON.stringify(data.user));
            JWT_TOKEN = data.token;
            CURRENT_USER_INFO = data.user;
            navigateToDashboard(data.user.vaiTro);
            showToast('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
        })
        .catch(error => showToast(error.message || 'T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!', 'error'));
    });

    function navigateToDashboard(vaiTro) {
        document.getElementById('loginSection').style.display = 'none';
        const userRole = vaiTro.toLowerCase().includes('admin') || vaiTro.toLowerCase().includes('quanly') ? 'admin' : 'staff';
        
        document.querySelectorAll('.dashboard').forEach(d => d.classList.remove('active'));
        
        if (userRole === 'admin') {
            document.getElementById('adminDashboard').classList.add('active');
            showAdminContent('products', document.querySelector('#adminDashboard .nav-tab.active')); 
        } else {
            document.getElementById('staffDashboard').classList.add('active');
            showStaffContent('orders', document.querySelector('#staffDashboard .nav-tab.active'));
        }
    }

    function logout() {
        localStorage.removeItem('token'); localStorage.removeItem('user_info');
        JWT_TOKEN = null; CURRENT_USER_INFO = null;
        document.getElementById('adminDashboard').classList.remove('active');
        document.getElementById('staffDashboard').classList.remove('active');
        document.getElementById('loginSection').style.display = 'flex';
        document.getElementById('loginForm').reset();
        showToast('ƒê√£ ƒëƒÉng xu·∫•t!', 'success');
    }

    // ==================== API HELPER ====================
    async function apiCall(endpoint, method = 'GET', data = null) {
        if (!JWT_TOKEN) {
            showToast('Phi√™n l√†m vi·ªác h·∫øt h·∫°n.', 'error'); logout(); throw new Error("Token missing");
        }
        const config = {
            method: method,
            headers: { 'Authorization': `Bearer ${JWT_TOKEN}`, 'Content-Type': 'application/json' },
            body: data ? JSON.stringify(data) : null
        };

        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
            let responseData;
            const text = await response.text();
            try { responseData = JSON.parse(text); } catch (e) { responseData = { message: "Th√†nh c√¥ng." }; }

            if (response.status === 401 || response.status === 403) {
                showToast(responseData.message || 'X√°c th·ª±c th·∫•t b·∫°i.', 'error'); logout(); throw new Error(responseData.message);
            }
            if (!response.ok) throw new Error(responseData.message || `L·ªói API: ${response.status}`);
            return responseData;
        } catch (error) {
            console.error(`L·ªói ${endpoint}:`, error);
            showToast(error.message, 'error'); throw error;
        }
    }

    (function checkLoginStatus() {
        if (JWT_TOKEN && CURRENT_USER_INFO) navigateToDashboard(CURRENT_USER_INFO.vaiTro);
    })();

    // ==================== NAVIGATION ====================
    function showAdminContent(contentId, clickedTab) {
        document.querySelectorAll('#adminDashboard .content-area').forEach(area => area.classList.remove('active'));
        const activeArea = document.getElementById(`admin-${contentId}`);
        if (activeArea) activeArea.classList.add('active');
        
        if(clickedTab) { 
            document.querySelectorAll('#adminDashboard .nav-tab').forEach(tab => tab.classList.remove('active'));
            clickedTab.classList.add('active');
        }

        switch(contentId) {
            case 'products': loadProducts(); break;
            case 'staff': loadStaff(); break;
            case 'orders': loadOrders(); break;
            case 'attendance': 
                loadEmployeeFilter(); loadAttendanceReport(); break;
            case 'tables': loadTables(); break;
        }
    }

    function showStaffContent(contentId, clickedTab) {
        document.querySelectorAll('#staffDashboard .content-area').forEach(area => area.classList.remove('active'));
        const activeArea = document.getElementById(`staff-${contentId}`);
        if (activeArea) activeArea.classList.add('active');
        
        if(clickedTab) {
             document.querySelectorAll('#staffDashboard .nav-tab').forEach(tab => tab.classList.remove('active'));
             clickedTab.classList.add('active');
        }

        switch(contentId) {
            case 'orders': loadTablesForStaff(); loadMenuForStaff(); break;
            case 'payment': loadPayments(); break;
            case 'menu': loadFullMenu(); break;
            case 'shifts': loadMyShifts(); break;
        }
    }

    // ==================== LOAD DATA FUNCTIONS ====================
    async function loadProducts() {
    try {
        const products = await apiCall('/products', 'GET');
        const tbody = document.getElementById('productsTableBody');
        tbody.innerHTML = '';

        // 1. T·∫°o b·∫£ng d·ªãch t√™n lo·∫°i
        const tenLoaiMap = {
            'DoUong': 'ƒê·ªì U·ªëng',
            'ThucAn': 'M√≥n ƒÇn'
        };

        products.forEach(product => {
            const row = tbody.insertRow();
            
            // 2. L·∫•y t√™n hi·ªÉn th·ªã, n·∫øu kh√¥ng kh·ªõp th√¨ l·∫•y gi√° tr·ªã g·ªëc
            const loaiHienThi = tenLoaiMap[product.loai] || product.loai;

            row.innerHTML = `
                <td><strong>${product.tenSP}</strong></td>
                <td>
                    <span class="badge-shift">${loaiHienThi}</span>
                </td>
                <td style="font-weight: 600; color: var(--primary);">${product.gia.toLocaleString()} VNƒê</td>
                <td><span class="status-badge status-active">Ho·∫°t ƒë·ªông</span></td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick='openEditModal(${JSON.stringify(product)})'><i class="fas fa-edit"></i> S·ª≠a</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.maSP})"><i class="fas fa-trash"></i> X√≥a</button>
                </td>
            `;
        });
    } catch (error) { 
        console.error("L·ªói t·∫£i s·∫£n ph·∫©m:", error); 
    }
}

function printOrder() {
    // 1. L·∫•y d·ªØ li·ªáu t·ª´ c√°c th·∫ª ID trong Modal
    const orderId = document.getElementById('detailOrderId').innerText;
    const tableName = document.getElementById('detailTableName').innerText;
    const staffName = document.getElementById('detailStaffName').innerText;
    const createdTime = document.getElementById('detailCreatedTime').innerText;
    const totalAmount = document.getElementById('detailTotalAmount').innerText;

    // 2. X√¢y d·ª±ng n·ªôi dung file vƒÉn b·∫£n (S·ª≠ d·ª•ng \n ƒë·ªÉ xu·ªëng d√≤ng)
    let billContent = "========== H√ìA ƒê∆†N THANH TO√ÅN ==========\n";
    billContent += `M√£ h√≥a ƒë∆°n: #${orderId}\n`;
    billContent += `Ng√†y t·∫°o:   ${createdTime}\n`;
    billContent += `B√†n:        ${tableName}\n`;
    billContent += `Nh√¢n vi√™n:  ${staffName}\n`;
    billContent += "----------------------------------------\n";
    
    // Header c·ªßa b·∫£ng m√≥n ƒÉn
    // S·ª≠ d·ª•ng padEnd ƒë·ªÉ cƒÉn ch·ªânh c·ªôt (gi·∫£ l·∫≠p d·∫°ng b·∫£ng trong notepad)
    billContent += "T√™n m√≥n".padEnd(20) + "SL".padEnd(5) + "ƒê∆°n gi√°".padEnd(12) + "Th√†nh ti·ªÅn\n";
    billContent += "----------------------------------------\n";

    // 3. L·∫•y danh s√°ch m√≥n ƒÉn t·ª´ b·∫£ng
    const rows = document.querySelectorAll('#detailItemsBody tr');
    
    rows.forEach(row => {
        const cols = row.querySelectorAll('td');
        if(cols.length > 0) {
            // L·∫•y text v√† x√≥a kho·∫£ng tr·∫Øng th·ª´a
            let name = cols[0].innerText.trim(); 
            let sl = cols[1].innerText.trim();
            let price = cols[2].innerText.trim();
            let total = cols[3].innerText.trim();

            // X·ª≠ l√Ω t√™n m√≥n qu√° d√†i (c·∫Øt b·ªõt n·∫øu c·∫ßn ƒë·ªÉ ƒë·∫πp ƒë·ªôi h√¨nh)
            if (name.length > 18) name = name.substring(0, 15) + "...";

            // C·ªông d·ªìn v√†o chu·ªói n·ªôi dung
            billContent += name.padEnd(20) + sl.padEnd(5) + price.padEnd(12) + total + "\n";
        }
    });

    billContent += "----------------------------------------\n";
    billContent += `T·ªîNG C·ªòNG:  ${totalAmount}\n`;
    billContent += "========================================\n";
    billContent += "C·∫£m ∆°n qu√Ω kh√°ch v√† h·∫πn g·∫∑p l·∫°i!";

    // 4. T·∫°o file v√† k√≠ch ho·∫°t t·∫£i xu·ªëng
    const blob = new Blob([billContent], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement("a");
    link.href = url;
    link.download = `HoaDon_${orderId}.txt`; // T√™n file khi t·∫£i v·ªÅ
    document.body.appendChild(link);
    link.click();
    
    // 5. D·ªçn d·∫πp
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

    async function loadStaff() {
    try {
        const staffList = await apiCall('/users', 'GET');
        const tbody = document.getElementById('staffTableBody');
        tbody.innerHTML = '';
        
        staffList.forEach(staff => {
            // --- B·∫ÆT ƒê·∫¶U ƒêO·∫†N LOGIC M·ªöI ---
            // L·∫•y th√¥ng tin ng∆∞·ªùi ƒëang ƒëƒÉng nh·∫≠p
            // Gi·∫£ s·ª≠ CURRENT_USER_INFO c√≥ tr∆∞·ªùng 'taiKhoan' gi·ªëng nh∆∞ ƒë·ªëi t∆∞·ª£ng staff
            const currentUserAccount = CURRENT_USER_INFO.taiKhoan;
            
            // Ki·ªÉm tra row hi·ªán t·∫°i c√≥ ph·∫£i l√† Qu·∫£n l√Ω hay kh√¥ng
            const isRowManager = staff.vaiTro.toLowerCase().includes('quanly');
            
            // Ki·ªÉm tra row hi·ªán t·∫°i c√≥ ph·∫£i l√† ch√≠nh m√¨nh hay kh√¥ng
            const isMe = (staff.taiKhoan === currentUserAccount);

            // LOGIC CH·∫∂N: 
            // N·∫øu ng∆∞·ªùi d√πng hi·ªán t·∫°i l√† Qu·∫£n l√Ω (ƒë√£ check ·ªü logic ƒëƒÉng nh·∫≠p),
            // V√† d√≤ng n√†y l√† m·ªôt Qu·∫£n l√Ω kh√°c (isRowManager ƒë√∫ng) NH∆ØNG kh√¥ng ph·∫£i m√¨nh (!isMe)
            // => Th√¨ b·ªè qua (return), kh√¥ng hi·ªÉn th·ªã.
            if (isRowManager && !isMe) {
                return; 
            }
            // --- K·∫æT TH√öC ƒêO·∫†N LOGIC M·ªöI ---

            const roleClass = staff.vaiTro.toLowerCase().includes('quanly') ? 'role-admin' : 'role-staff';
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><strong>${staff.tenNV}</strong></td>
                <td><span class="${roleClass}">${staff.vaiTro}</span></td>
                <td>${staff.taiKhoan}</td>
                <td><span class="badge-shift">${staff.caLamViec || 'Ch∆∞a x·∫øp'}</span></td>
                <td><span class="status-badge status-active">Ho·∫°t ƒë·ªông</span></td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick='showEditStaffModal(${JSON.stringify(staff)})'><i class="fas fa-edit"></i> S·ª≠a</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteStaff('${staff.maNV}')"><i class="fas fa-trash"></i> X√≥a</button>
                    <button class="btn btn-info btn-sm" onclick="resetPassword('${staff.maNV}')" title="Reset m·∫≠t kh·∫©u"><i class="fas fa-key"></i></button>
                </td>
            `;
        });
    } catch (error) {
        console.error("L·ªói t·∫£i danh s√°ch nh√¢n vi√™n:", error);
    }
}
    async function loadOrders() {
        try {
            const orders = await apiCall('/orders', 'GET');
            allOrdersList = orders;
            renderOrderTable(allOrdersList);
        } catch (error) { console.error("L·ªói t·∫£i ƒë∆°n h√†ng:", error); }
    }

    function renderOrderTable(orders) {
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = ''; 
        if (orders.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng</td></tr>'; return; }
        orders.forEach(order => {
            const row = tbody.insertRow();
            let statusBadge = 'status-pending', statusText = order.trangThai;
            if (order.trangThai === 'DaThanhToan') { statusBadge = 'status-active'; statusText = 'ƒê√£ thanh to√°n'; }
            else if (order.trangThai === 'Huy') { statusBadge = 'status-rejected'; statusText = 'ƒê√£ h·ªßy'; }
            else { statusBadge = 'status-pending'; statusText = 'ƒêang x·ª≠ l√Ω'; }

            row.innerHTML = `
                <td><strong>#${order.maDH}</strong></td>
                <td><i class="fas fa-chair"></i> B√†n ${order.maBan}</td>
                <td style="font-weight: 700; color: var(--primary);">${order.tongTien.toLocaleString()} VNƒê</td>
                <td><span class="status-badge ${statusBadge}">${statusText}</span></td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick='showOrderDetail(${JSON.stringify(order)})'><i class="fas fa-eye"></i> Chi ti·∫øt</button>
                </td>
            `;
        });
    }

    function searchOrder() {
        const keyword = document.getElementById('orderSearchInput').value.trim().toLowerCase();
        if (!keyword) { renderOrderTable(allOrdersList); return; }
        renderOrderTable(allOrdersList.filter(order => order.maDH.toString().includes(keyword)));
    }
    function resetOrderSearch() { document.getElementById('orderSearchInput').value = ''; renderOrderTable(allOrdersList); }

    async function loadTables() {
        try {
            const tables = await apiCall('/tables', 'GET');
            const grid = document.getElementById('adminTableGrid');
            grid.innerHTML = ''; 
            tables.forEach(table => {
                let statusClass = 'available', statusText = 'Tr·ªëng', statusBadge = 'status-active', bgColor = '#dcfce7';
                if (table.trangThai !== 'Trong') { 
                    statusClass = 'occupied'; statusText = 'C√≥ kh√°ch'; statusBadge = 'status-rejected'; bgColor = '#fee2e2';
                }
                const tableDiv = document.createElement('div');
                tableDiv.className = `table-item`;
                tableDiv.style = `background: ${bgColor}; padding: 20px;`;
                tableDiv.innerHTML = `
                    <h4 style="margin-bottom: 10px;"><i class="fas fa-chair"></i> ${table.tenBan}</h4>
                    <span class="status-badge ${statusBadge}">${statusText}</span>
                    <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: center;">
                        <button class="btn btn-warning btn-sm" onclick="openEditTableModal(${table.maBan}, '${table.tenBan}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="deleteTable(${table.maBan})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                grid.appendChild(tableDiv);
            });
        } catch (error) { console.error("L·ªói t·∫£i b√†n:", error); }
    }

    async function loadTablesForStaff() {
        try {
            const tables = await apiCall('/tables', 'GET');
            const select = document.getElementById('orderTable');
            select.innerHTML = '<option value="">Ch·ªçn b√†n</option>'; 
            tables.forEach(table => {
                const option = document.createElement('option');
                option.value = table.maBan;
                option.textContent = `${table.tenBan} - ${table.trangThai}`;
                select.appendChild(option);
            });
        } catch (error) { console.error("L·ªói t·∫£i b√†n:", error); }
    }

    async function loadMenuForStaff() {
        try {
            const products = await apiCall('/products', 'GET');
            const grid = document.getElementById('staffMenuGrid');
            grid.innerHTML = ''; 
            products.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.className = 'menu-item';
                productDiv.setAttribute('onclick', `addToOrder(${JSON.stringify(product)})`);
                productDiv.innerHTML = `<strong>${product.tenSP}</strong><p>${product.gia.toLocaleString()} VNƒê</p>`;
                grid.appendChild(productDiv);
            });
        } catch (error) { console.error("L·ªói t·∫£i menu:", error); }
    }

    async function loadFullMenu() {
        try {
            const products = await apiCall('/products', 'GET');
            const grid = document.getElementById('staffFullMenuGrid');
            grid.innerHTML = ''; 
            const categories = {};
            products.forEach(product => {
                if (!categories[product.loai]) categories[product.loai] = []; 
                categories[product.loai].push(product);
            });
            for (const categoryName in categories) {
                let itemsHtml = '<div style="margin-top: 16px;">';
                categories[categoryName].forEach(item => {
                    itemsHtml += `<div style="display: flex; justify-content: space-between; padding: 12px; background: var(--light); border-radius: 8px; margin-bottom: 8px;"><span>${item.tenSP}</span><strong style="color: var(--primary);">${item.gia.toLocaleString()} VNƒê</strong></div>`;
                });
                itemsHtml += '</div>';
                const categoryDiv = document.createElement('div');
                categoryDiv.style = "border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; background: white;";
                categoryDiv.innerHTML = `<h4 style="color: var(--dark); border-bottom: 2px solid var(--primary); padding-bottom: 8px; display: inline-block;">${categoryName}</h4>${itemsHtml}`;
                grid.appendChild(categoryDiv);
            }
        } catch (error) { console.error("L·ªói t·∫£i menu:", error); }
    }

    async function loadMyShifts() {
        const tbody = document.getElementById('staffShiftsTableBody');
        tbody.innerHTML = `<tr><td colspan="6" style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...</td></tr>`;
        try {
            const myShifts = await apiCall('/shifts/my', 'GET');
            if (!myShifts || myShifts.length === 0) { tbody.innerHTML = `<tr><td colspan="6" style="text-align: center;">Ch∆∞a ƒë∆∞·ª£c x·∫øp ca.</td></tr>`; return; }
            tbody.innerHTML = '';
            myShifts.forEach(shift => {
                const start = new Date(shift.gioBatDau); const end = new Date(shift.gioKetThuc);
                const timeOpt = { hour: '2-digit', minute: '2-digit', hour12: false };
                const diffHours = ((end - start) / (1000 * 60 * 60)).toFixed(1);
                tbody.insertRow().innerHTML = `
                    <td>${new Date(shift.ngayLamViec).toLocaleDateString('vi-VN')}</td>
                    <td><span class="badge-shift">${shift.tenCa}</span></td>
                    <td>${start.toLocaleTimeString('vi-VN', timeOpt)}</td>
                    <td>${end.toLocaleTimeString('vi-VN', timeOpt)}</td>
                    <td>${diffHours}h</td>
                    <td><span class="status-badge status-active">ƒê√£ x·∫øp l·ªãch</span></td>
                `;
            });
        } catch (error) { tbody.innerHTML = `<tr><td colspan="6" style="text-align: center;">L·ªói t·∫£i d·ªØ li·ªáu.</td></tr>`; }
    }

    async function loadPayments() {
        try {
            const orders = await apiCall('/orders', 'GET');
            const tbody = document.getElementById('paymentTableBody');
            tbody.innerHTML = '';
            const pendingOrders = orders.filter(o => o.trangThai === 'DangXuLy');
            if (pendingOrders.length === 0) { tbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Kh√¥ng c√≥ ƒë∆°n h√†ng ch·ªù thanh to√°n</td></tr>`; return; }
            pendingOrders.forEach(order => {
                const monAn = order.ChiTietDonHangs ? order.ChiTietDonHangs.map(item => item.SanPham ? item.SanPham.tenSP : '...').join(', ') : '...';
                tbody.insertRow().innerHTML = `
                    <td><i class="fas fa-chair"></i> B√†n ${order.maBan}</td>
                    <td>${order.tenKhachHang || 'Kh√°ch l·∫ª'}</td>
                    <td>${monAn}</td>
                    <td style="font-weight: 700; color: var(--primary);">${order.tongTien.toLocaleString()} VNƒê</td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="processPayment(${order.maDH}, ${order.maBan})"><i class="fas fa-check"></i> Thanh to√°n</button>
                        <button class="btn btn-danger btn-sm" onclick="cancelOrder(${order.maDH})"><i class="fas fa-times"></i> H·ªßy</button>
                    </td>
                `;
            });
        } catch (error) { console.error("L·ªói t·∫£i thanh to√°n:", error); }
    }

    // ==================== REPORTING ====================
    function filterRevenue(type) {
        const today = new Date(); let fromDate = new Date(), toDate = new Date();
        if (type === 'week') { fromDate.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1)); }
        else if (type === 'month') { fromDate = new Date(today.getFullYear(), today.getMonth(), 1); }
        document.getElementById("revFrom").value = fromDate.toISOString().split('T')[0];
        document.getElementById("revTo").value = toDate.toISOString().split('T')[0];
        loadRevenueReport();
    }

    async function loadRevenueReport() {
        const from = document.getElementById("revFrom").value;
        const to = document.getElementById("revTo").value;
        try {
            // Doanh thu
            const resRev = await fetch(`${REPORT_API}/revenue?type=date&from=${from}&to=${to}`, { headers: { "Authorization": `Bearer ${JWT_TOKEN}` } });
            const dataRev = await resRev.json();
            const tbody = document.getElementById("revenueTableBody"); tbody.innerHTML = "";
            let total = 0;
            if (dataRev.length) dataRev.forEach(item => { total += item.doanhThu; tbody.insertRow().innerHTML = `<td>${item.ngay}</td><td style="font-weight: bold;">${parseInt(item.doanhThu).toLocaleString()} VNƒê</td>`; });
            else tbody.innerHTML = `<tr><td colspan="2" style="text-align:center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
            document.getElementById("totalRevenueSum").innerText = total.toLocaleString('vi-VN') + " VNƒê";

            // Top Products
            const resProd = await fetch(`${REPORT_API}/top-products?top=10&from=${from}&to=${to}`, { headers: { "Authorization": `Bearer ${JWT_TOKEN}` } });
            const dataProd = await resProd.json();
            const prodBody = document.getElementById("topProductsBody"); prodBody.innerHTML = "";
            if (dataProd.length) dataProd.forEach(p => prodBody.insertRow().innerHTML = `<td>${p.tenSP}</td><td>${p.loai}</td><td style="color: blue; font-weight: bold; text-align: center;">${p.soLuongBan}</td><td>${parseInt(p.gia).toLocaleString()} VNƒê</td>`);
            else prodBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
        } catch (e) { console.error("L·ªói b√°o c√°o:", e); }
    }

    async function loadAttendanceReport() {
        const filterNvId = document.getElementById('filterEmployee').value;
        const fromDate = document.getElementById('filterFromDate').value;
        const toDate = document.getElementById('filterToDate').value;
        try {
            const shifts = await apiCall('/shifts', 'GET');
            const tbody = document.getElementById('attendanceReportBody'); tbody.innerHTML = '';
            const filtered = shifts.filter(s => {
                if (filterNvId !== 'all' && s.maNV != filterNvId) return false;
                if (fromDate && s.ngayLamViec < fromDate) return false;
                if (toDate && s.ngayLamViec > toDate) return false;
                return true;
            });
            if (filtered.length === 0) { tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`; return; }
            filtered.forEach(shift => {
                const staffName = shift.NhanVien ? shift.NhanVien.tenNV : `NV #${shift.maNV}`;
                const timeIn = shift.gioBatDau 
    ? new Date(new Date(shift.gioBatDau).getTime() - 8 * 3600000)
        .toLocaleTimeString("vi-VN", { hour: '2-digit', minute: '2-digit', hour12:false })
    : "--:--";
                const timeOut = shift.gioKetThuc ? new Date(shift.gioKetThuc).toLocaleTimeString('vi-VN', {hour:'2-digit',minute:'2-digit',hour12:false}) : '--:--';
                
                // Simple Analysis
                let analysis = '<span class="status-badge status-active">‚úÖ T·ªët</span>';
                if(shift.gioBatDau) {
                    const inH = new Date(shift.gioBatDau).getHours();
                    const configStart = SHIFT_CONFIG[shift.tenCa] ? SHIFT_CONFIG[shift.tenCa].start : 0;
                    if(configStart && inH > configStart) analysis = '<span class="status-badge status-rejected">‚ö†Ô∏è ƒêi mu·ªôn</span>';
                }

                tbody.insertRow().innerHTML = `
                    <td><i class="fas fa-calendar"></i> ${new Date(shift.ngayLamViec).toLocaleDateString('vi-VN')}</td>
                    <td style="font-weight:bold;">${staffName}</td>
                    <td><span class="badge-shift">${shift.tenCa}</span></td>
                    <td>${timeIn}</td>
                    <td>${timeOut}</td>
                    <td>${analysis}</td>
                `;
            });
        } catch (e) { console.error(e); }
    }

    async function loadEmployeeFilter() {
        try {
            const list = await apiCall('/users', 'GET');
            const sel = document.getElementById('filterEmployee');
            sel.innerHTML = '<option value="all">-- T·∫•t c·∫£ nh√¢n vi√™n --</option>';
            list.forEach(s => sel.innerHTML += `<option value="${s.maNV}">${s.tenNV}</option>`);
        } catch (e) {}
    }

    // ==================== ACTIONS (CRUD) ====================
    function showAddProductModal() { document.getElementById('addProductModal').classList.add('active'); }
    function showAddStaffModal() { document.getElementById('addStaffModal').classList.add('active'); }
    function showAddTableModal() {
    const modal = document.getElementById('addTableModal');
    if (modal) {
        // L·ªánh n√†y ƒë·∫£m b·∫£o Modal ƒë∆∞·ª£c th√™m class active (Hi·ªÉn th·ªã)
        modal.classList.add('active'); 
        
        // L·ªánh n√†y quan tr·ªçng: N√≥ ch·∫°y sau 10ms, ƒë·∫£m b·∫£o n·∫øu c√≥ h√†m n√†o 
        // ch·∫°y song song c·ªë g·∫Øng ·∫©n Modal (v√≠ d·ª•: h√†m loadTables), 
        // th√¨ l·ªánh hi·ªán Modal c·ªßa ch√∫ng ta s·∫Ω ghi ƒë√® l√™n sau.
        setTimeout(() => {
            modal.classList.add('active'); // Th√™m l·∫°i l·∫ßn n·ªØa ƒë·ªÉ ghi ƒë√®
            document.getElementById('tableName').focus();
        }, 10); // 10ms l√† ƒë·ªß ƒë·ªÉ gi·∫£i quy·∫øt xung ƒë·ªôt DOM render/repaint
    } else {
        console.error("L·ªói: Kh√¥ng t√¨m th·∫•y modal c√≥ ID 'addTableModal'");
    }
}
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function showChangePasswordModal() { document.getElementById('changePasswordModal').classList.add('active'); }
    function closeChangePasswordModal() { document.getElementById('changePasswordModal').classList.remove('active'); }

    async function addProduct() {
        const body = { tenSP: document.getElementById('productName').value, loai: document.getElementById('productCategory').value, gia: parseFloat(document.getElementById('productPrice').value) };
        if(!body.tenSP || !body.gia) return showToast("Nh·∫≠p thi·∫øu th√¥ng tin", "error");
        try { await apiCall('/products', 'POST', body); closeModal('addProductModal'); showToast('Th√™m th√†nh c√¥ng!'); loadProducts(); } catch(e){}
    }

    function openEditModal(p) {
        document.getElementById("edit_maSP").value = p.maSP;
        document.getElementById("edit_tenSP").value = p.tenSP;
        document.getElementById("edit_loai").value = p.loai;
        document.getElementById("edit_gia").value = p.gia;
        document.getElementById("editProductModal").classList.add("active");
    }

    async function confirmEditProduct() {
        const id = document.getElementById("edit_maSP").value;
        const body = { tenSP: document.getElementById("edit_tenSP").value, loai: document.getElementById("edit_loai").value, gia: parseFloat(document.getElementById("edit_gia").value) };
        try { await apiCall(`/products/${id}`, 'PUT', body); closeModal('editProductModal'); showToast("C·∫≠p nh·∫≠t th√†nh c√¥ng!"); loadProducts(); } catch(e){}
    }

    async function deleteProduct(id) {
        if(confirm("X√≥a s·∫£n ph·∫©m n√†y?")) { try { await apiCall(`/products/${id}`, 'DELETE'); showToast("ƒê√£ x√≥a!"); loadProducts(); } catch(e){} }
    }

    async function addStaff() {
        const body = { tenNV: document.getElementById('staffName').value, vaiTro: document.getElementById('staffRole').value, taiKhoan: document.getElementById('staffEmail').value, matKhau: "123456", caLamViec: "Ca s√°ng" };
        if(!body.tenNV || !body.taiKhoan) return showToast("Nh·∫≠p thi·∫øu th√¥ng tin", "error");
        try { await apiCall('/users', 'POST', body); closeModal('addStaffModal'); showToast('Th√™m nh√¢n vi√™n th√†nh c√¥ng!'); loadStaff(); } catch(e){}
    }

    function showEditStaffModal(s) {
    // Fill d·ªØ li·ªáu c≈©
    document.getElementById('editStaffId').value = s.maNV;
    document.getElementById('editStaffName').value = s.tenNV;
    document.getElementById('editStaffRole').value = s.vaiTro;
    document.getElementById('editStaffEmail').value = s.taiKhoan;
    document.getElementById('editStaffShift').value = s.caLamViec || 'Ca s√°ng';

    // --- LOGIC M·ªöI: X·ª≠ l√Ω ·∫©n/hi·ªán √¥ M·∫≠t kh·∫©u ---
    const passGroup = document.getElementById('editStaffPasswordGroup');
    const passInput = document.getElementById('editStaffPassword');
    
    // Lu√¥n reset √¥ m·∫≠t kh·∫©u v·ªÅ r·ªóng m·ªói khi m·ªü modal
    passInput.value = '';

    // Ki·ªÉm tra: Ng∆∞·ªùi ƒëang ƒëƒÉng nh·∫≠p (CURRENT_USER_INFO) c√≥ tr√πng v·ªõi ng∆∞·ªùi ƒëang s·ª≠a (s) kh√¥ng?
    // So s√°nh theo T√†i kho·∫£n ho·∫∑c M√£ NV
    if (CURRENT_USER_INFO.taiKhoan === s.taiKhoan) {
        passGroup.style.display = 'block'; // L√† m√¨nh th√¨ hi·ªán
    } else {
        passGroup.style.display = 'none';  // L√† nh√¢n vi√™n th√¨ ·∫©n
    }
    // --------------------------------------------

    document.getElementById('editStaffModal').classList.add('active');
}

    async function handleUpdateStaff() {
    const id = document.getElementById('editStaffId').value;
    
    // C√°c th√¥ng tin c∆° b·∫£n
    const body = { 
        tenNV: document.getElementById('editStaffName').value, 
        vaiTro: document.getElementById('editStaffRole').value, 
        taiKhoan: document.getElementById('editStaffEmail').value, 
        caLamViec: document.getElementById('editStaffShift').value 
    };

    // --- LOGIC M·ªöI: K√®m m·∫≠t kh·∫©u n·∫øu c√≥ ---
    const passGroup = document.getElementById('editStaffPasswordGroup');
    const newPass = document.getElementById('editStaffPassword').value;

    // Ch·ªâ c·∫≠p nh·∫≠t m·∫≠t kh·∫©u n·∫øu:
    // 1. √î m·∫≠t kh·∫©u ƒëang hi·ªán (t·ª©c l√† ƒëang s·ª≠a ch√≠nh m√¨nh)
    // 2. Ng∆∞·ªùi d√πng C√ì nh·∫≠p m·∫≠t kh·∫©u m·ªõi (kh√¥ng b·ªè tr·ªëng)
    if (passGroup.style.display !== 'none' && newPass.trim() !== '') {
        body.matKhau = newPass;
    }
    // --------------------------------------

    try { 
        await apiCall(`/users/${id}`, 'PUT', body); 
        closeModal('editStaffModal'); 
        showToast('C·∫≠p nh·∫≠t th√†nh c√¥ng!'); 
        loadStaff(); 
    } catch(e) {
        console.error(e);
        showToast('L·ªói: ' + e.message, 'error');
    }
}

    async function deleteStaff(id) {
        if(confirm("X√≥a nh√¢n vi√™n n√†y?")) { try { await apiCall(`/users/${id}`, 'DELETE'); showToast("ƒê√£ x√≥a!"); loadStaff(); } catch(e){} }
    }

    async function addTable() {
    // 1. Ki·ªÉm tra xem n√∫t b·∫•m c√≥ ƒÉn kh√¥ng
    console.log("--- B·∫Øt ƒë·∫ßu th√™m b√†n ---");

    // 2. L·∫•y gi√° tr·ªã t·ª´ √¥ input
    const inputElement = document.getElementById('tableName');
    if (!inputElement) {
        alert("L·ªói: Kh√¥ng t√¨m th·∫•y √¥ nh·∫≠p t√™n b√†n (Sai ID HTML)");
        return;
    }

    const name = inputElement.value.trim();
    
    // 3. Ki·ªÉm tra d·ªØ li·ªáu r·ªóng
    if (!name) {
        alert("Vui l√≤ng nh·∫≠p t√™n b√†n!");
        return;
    }

    // 4. G·ªçi API v√† b·∫Øt l·ªói chi ti·∫øt
    try {
        console.log("ƒêang g·ª≠i d·ªØ li·ªáu l√™n server:", { tenBan: name, trangThai: "Trong" });
        
        // L∆∞u √Ω: ƒê·∫£m b·∫£o backend c·ªßa b·∫°n nh·∫≠n ƒë√∫ng ch·ªØ "Tr·ªëng" (c√≥ d·∫•u) ho·∫∑c "Trong" (kh√¥ng d·∫•u)
        await apiCall('/tables', 'POST', { 
            tenBan: name, 
            trangThai: "Trong" 
        });

        // 5. Th√†nh c√¥ng
        console.log("Th√™m th√†nh c√¥ng!");
        closeModal('addTableModal');
        
        // N·∫øu b·∫°n c√≥ h√†m showToast th√¨ d√πng, kh√¥ng th√¨ d√πng alert t·∫°m
        if (typeof showToast === 'function') {
            showToast("Th√™m b√†n th√†nh c√¥ng!");
        } else {
            alert("Th√™m b√†n th√†nh c√¥ng!");
        }

        // X√≥a tr·∫Øng √¥ nh·∫≠p
        inputElement.value = '';
        
        // T·∫£i l·∫°i danh s√°ch
        if (typeof loadTables === 'function') {
            loadTables();
        }

    } catch (e) {
        // 6. QUAN TR·ªåNG: Hi·ªán l·ªói ra m√†n h√¨nh ƒë·ªÉ bi·∫øt sai ·ªü ƒë√¢u
        console.error("L·ªói API:", e);
        alert("L·ªói khi th√™m b√†n: " + (e.message || e));
    }
}
    
    function openEditTableModal(id, name) {
        document.getElementById('editTableId').value = id; document.getElementById('editTableName').value = name;
        document.getElementById('editTableModal').classList.add('active');
    }

    async function handleUpdateTable() {
        const id = document.getElementById('editTableId').value;
        const name = document.getElementById('editTableName').value;
        try { await apiCall(`/tables/${id}`, 'PUT', { tenBan: name }); closeModal('editTableModal'); showToast("C·∫≠p nh·∫≠t th√†nh c√¥ng!"); loadTables(); } catch(e){}
    }

    async function deleteTable(id) {
        if(confirm("X√≥a b√†n n√†y?")) { try { await apiCall(`/tables/${id}`, 'DELETE'); showToast("ƒê√£ x√≥a!"); loadTables(); } catch(e){} }
    }

    // ==================== ORDER & PAYMENT ====================
    function addToOrder(p) {
        const exist = currentOrder.find(i => i.maSP === p.maSP);
        if (exist) exist.soLuong++; else currentOrder.push({ ...p, soLuong: 1 });
        updateOrderSummary(); showToast(`ƒê√£ th√™m ${p.tenSP}`);
    }

    function updateOrderSummary() {
        const div = document.getElementById('orderItems');
        if (currentOrder.length === 0) { div.innerHTML = '<p style="text-align:center;color:#6b7280;">Ch∆∞a c√≥ m√≥n n√†o</p>'; document.getElementById('orderTotal').innerText = '0 VNƒê'; return; }
        let html = '', total = 0;
        currentOrder.forEach((item, idx) => {
            total += item.gia * item.soLuong;
            html += `<p><span><strong>${item.tenSP}</strong><br><small>x${item.soLuong}</small></span> <span style="display:flex;align-items:center;gap:8px;">${(item.gia*item.soLuong).toLocaleString()} <button class="btn btn-danger btn-sm" onclick="currentOrder.splice(${idx},1);updateOrderSummary();"><i class="fas fa-trash"></i></button></span></p>`;
        });
        div.innerHTML = html; document.getElementById('orderTotal').innerText = total.toLocaleString() + ' VNƒê';
    }

    async function confirmOrder() {
        const maBan = document.getElementById('orderTable').value;
        if(!maBan || !currentOrder.length) return showToast("Ch·ªçn b√†n v√† m√≥n!", "error");
        const body = { 
            maNV: CURRENT_USER_INFO.maNV, maBan: parseInt(maBan), 
            tongTien: currentOrder.reduce((t, i) => t + i.gia * i.soLuong, 0),
            trangThai: "DangXuLy", items: currentOrder.map(i => ({ maSP: i.maSP, soLuong: i.soLuong })) 
        };
        try {
            await apiCall('/orders', 'POST', body);
            await apiCall(`/tables/${maBan}/status`, 'PATCH', { trangThai: 'DangPhucVu' });
            currentOrder = []; updateOrderSummary(); showToast("ƒê∆°n h√†ng ƒë√£ t·∫°o!", "success");
            loadTablesForStaff(); loadTables();
        } catch(e){}
    }

    function showOrderDetail(order) {
        document.getElementById('detailOrderId').innerText = order.maDH;
        document.getElementById('detailTableName').innerText = `B√†n ${order.maBan}`;
        document.getElementById('detailStaffName').innerText = order.NhanVien ? order.NhanVien.tenNV : 'N/A';
        document.getElementById('detailCreatedTime').innerText = new Date(order.thoiGian).toLocaleString('vi-VN');
        document.getElementById('detailPaymentTime').innerText = order.trangThai === 'DaThanhToan' ? new Date(order.updatedAt).toLocaleString('vi-VN') : '---';
        
        let statusText = order.trangThai, statusClass = 'status-pending';
        if(order.trangThai === 'DaThanhToan') { statusText='ƒê√£ thanh to√°n'; statusClass='status-active'; }
        else if(order.trangThai === 'Huy') { statusText='ƒê√£ h·ªßy'; statusClass='status-rejected'; }
        const badge = document.getElementById('detailStatusBadge');
        badge.className = `status-badge ${statusClass}`; badge.innerText = statusText;
        document.getElementById('detailTotalAmount').innerText = order.tongTien.toLocaleString() + ' VNƒê';

        const tbody = document.getElementById('detailItemsBody'); tbody.innerHTML = '';
        if(order.ChiTietDonHangs) order.ChiTietDonHangs.forEach(i => {
            const sp = i.SanPham || { tenSP: 'ƒê√£ x√≥a', gia: 0 };
            tbody.insertRow().innerHTML = `<td>${sp.tenSP}</td><td style="text-align:center;">${i.soLuong}</td><td style="text-align:right;">${sp.gia.toLocaleString()}</td><td style="text-align:right;font-weight:bold;">${(sp.gia*i.soLuong).toLocaleString()}</td>`;
        });
        document.getElementById('orderDetailModal').classList.add('active');
    }

    async function processPayment(oid, tid) {
        if(!confirm("X√°c nh·∫≠n thanh to√°n?")) return;
        try {
            await apiCall(`/orders/${oid}`, 'PUT', { trangThai: 'DaThanhToan' });
            if(tid) await apiCall(`/tables/${tid}/status`, 'PATCH', { trangThai: 'Trong' });
            showToast("Thanh to√°n th√†nh c√¥ng!", "success"); loadPayments(); loadTables(); loadTablesForStaff();
            downloadInvoiceByOrderId(oid);
        } catch(e){}
    }

    async function cancelOrder(oid) {
        if(confirm("H·ªßy ƒë∆°n h√†ng n√†y?")) { try { await apiCall(`/orders/${oid}`, 'PUT', { trangThai: 'Huy' }); showToast("ƒê√£ h·ªßy!"); loadPayments(); } catch(e){} }
    }

    // ==================== ATTENDANCE & OTHER ====================
    let isShiftActive = false;
    async function handleNavAttendanceClick() {
        if (isShiftActive) await handleSelfCheckOut(); else await handleSelfCheckIn();
    }
    async function handleSelfCheckIn() {
        const now = new Date(); const h = now.getHours();
        let ca = "";
        if (h>=6 && h<12) ca="Ca S√°ng"; else if(h>=12 && h<18) ca="Ca Chi·ªÅu"; else if(h>=18 && h<=23) ca="Ca T·ªëi";
        else return showToast("Kh√¥ng ph·∫£i gi·ªù l√†m vi·ªác!", "error");
        
        try {
            await apiCall('/shifts', 'POST', { maNV: CURRENT_USER_INFO.maNV, ngayLamViec: now.toISOString().split('T')[0], tenCa: ca, gioBatDau: now.toLocaleTimeString('vi-VN',{hour12:false}), gioKetThuc: null });
            showToast(`ƒê√£ v√†o ${ca}`, "success"); updateNavButtonState(true);
        } catch(e) {}
    }
    async function handleSelfCheckOut() {
        if(!confirm("K·∫øt th√∫c ca l√†m vi·ªác?")) return;
        const now = new Date();
        try {
            const shifts = await apiCall('/shifts/my', 'GET');
            const active = shifts.find(s => !s.gioKetThuc);
            if(active) {
                await apiCall(`/shifts/${active.maLich}`, 'PUT', { gioKetThuc: now.toLocaleTimeString('vi-VN',{hour12:false}) });
                showToast("ƒê√£ tan ca", "success"); updateNavButtonState(false);
            }
        } catch(e){}
    }
    function updateNavButtonState(active) {
        isShiftActive = active;
        const btn = document.getElementById('navAttendanceBtn');
        if(active) { btn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Tan ca'; btn.style.backgroundColor = '#e74c3c'; }
        else { btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> V√†o ca'; btn.style.backgroundColor = '#2ecc71'; }
    }
    async function checkAttendanceStatus() {
        try {
            const shifts = await apiCall('/shifts/my', 'GET');
            updateNavButtonState(shifts.some(s => !s.gioKetThuc));
        } catch(e){}
    }
    
    async function changePassword() {
    console.log("H√†m changePassword ƒë√£ ƒë∆∞·ª£c g·ªçi. ƒêang ki·ªÉm tra d·ªØ li·ªáu.");
    
    // L·∫•y gi√° tr·ªã ngay l·∫≠p t·ª©c
    const oldP = document.getElementById('oldPassword').value.trim(); // Th√™m .trim() ƒë·ªÉ lo·∫°i b·ªè kho·∫£ng tr·∫Øng
    const newP = document.getElementById('newPassword').value.trim();
    const conP = document.getElementById('confirmPassword').value.trim();
    
    // ‚ö†Ô∏è B∆Ø·ªöC 1: KI·ªÇM TRA R·ªñNG T·∫†I FRONTEND (Quan tr·ªçng)
    if (!oldP || !newP || !conP) {
        showToast("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß 3 tr∆∞·ªùng m·∫≠t kh·∫©u.", "error");
        console.error("L·ªói Frontend: M·ªôt tr∆∞·ªùng m·∫≠t kh·∫©u b·ªã r·ªóng.");
        return; // D·ª´ng h√†m ngay l·∫≠p t·ª©c n·∫øu thi·∫øu
    }

    // ‚ö†Ô∏è B∆Ø·ªöC 2: KI·ªÇM TRA M·∫¨T KH·∫®U KH·ªöP NHAU
    if (newP !== conP) {
        showToast("M·∫≠t kh·∫©u m·ªõi kh√¥ng kh·ªõp!", "error");
        return;
    }
    
    // ‚ö†Ô∏è B∆Ø·ªöC 3: KI·ªÇM TRA ƒê·ªò D√ÄI
    if (newP.length < 6) { 
        showToast("M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±.", "error");
        return;
    }

    try {
        await apiCall('/users/change-password', 'PUT', { 
            oldPassword: oldP, 
            newPassword: newP,
            confirmPassword: conP // G·ª≠i ƒë·ªß 3 tr∆∞·ªùng theo y√™u c·∫ßu c·ªßa Backend
        });
        
        // Th√†nh c√¥ng
        showToast("ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!"); 
        
        // Reset form sau khi ƒë·ªïi th√†nh c√¥ng
        document.getElementById('changePasswordForm').reset();
        closeChangePasswordModal();

    } catch(e) {
        console.error("L·ªói ƒë·ªïi m·∫≠t kh·∫©u:", e);
        const errorMessage = e.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh khi ƒë·ªïi m·∫≠t kh·∫©u.";
        showToast(errorMessage, "error");
    }
}

    // Toast Helper
    function showToast(msg, type = 'success') {
        const t = document.createElement('div'); t.className = `toast ${type}`;
        t.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':type==='error'?'exclamation-circle':'info-circle'}"></i> ${msg}`;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    // Invoice Download
    async function downloadInvoiceByOrderId(id) {
        try {
            const o = await apiCall(`/orders/${id}`, 'GET');
            let text = `H√ìA ƒê∆†N #${id}\nB√†n: ${o.maBan}\nNg√†y: ${new Date().toLocaleString('vi-VN')}\n----------------\n`;
            o.ChiTietDonHangs.forEach(i => text+=`${i.SanPham.tenSP} x${i.soLuong} : ${(i.SanPham.gia*i.soLuong).toLocaleString()}\n`);
            text += `----------------\nT·ªîNG: ${o.tongTien.toLocaleString()} VNƒê`;
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([text], {type:'text/plain'}));
            a.download = `HoaDon_${id}.txt`; document.body.appendChild(a); a.click(); a.remove();
        } catch(e){}
    }

    // Google Init
    window.onload = function () {
        google.accounts.id.initialize({ client_id: "420409451031-jpsu99k3t2r1kqmnjluhs5uppgtghomt.apps.googleusercontent.com", callback: handleGoogleResponse });
        google.accounts.id.renderButton(document.getElementById("g_id_signin"), { theme: "outline", size: "large" });
        checkAttendanceStatus();
        updateOrderSummary();
    };

    async function handleGoogleResponse(response) {
        try {
            const res = await fetch(`${API_BASE_URL}/auth/google`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ tokenId: response.credential }) });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message);
            localStorage.setItem("token", data.token); localStorage.setItem("user_info", JSON.stringify(data.user));
            JWT_TOKEN = data.token; CURRENT_USER_INFO = data.user;
            navigateToDashboard(data.user.vaiTro); showToast("ƒêƒÉng nh·∫≠p Google th√†nh c√¥ng!");
        } catch (e) { showToast(e.message, "error"); }
    }

// H√†m x·ª≠ l√Ω ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u
async function resetPassword(maNV) {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u cho nh√¢n vi√™n n√†y v·ªÅ m·∫∑c ƒë·ªãnh (v√≠ d·ª•: 123456) kh√¥ng?')) {
        try {
            // G·ªçi API ƒë·ªÉ reset m·∫≠t kh·∫©u (b·∫°n c·∫ßn API backend h·ªó tr·ª£ vi·ªác n√†y)
            // V√≠ d·ª•: await apiCall(`/users/reset-password/${maNV}`, 'POST');
            
            alert('ƒê√£ ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u th√†nh c√¥ng!');
        } catch (error) {
            console.error(error);
            alert('L·ªói khi ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u');
        }
    }
}

    
    </script>


</body>
</html>